<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>My Store | Tienda de Apps</title>
  <link rel="icon" href="img/logo.png" type="image/png">
  <link rel="stylesheet" href="styles/styles.css">
  <link rel="stylesheet" href="styles/animations.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
  /* --- HEADER --- */
  header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(12px);
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.7rem 1.2rem;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    z-index: 1000;
  }

  header h1 {
    color: var(--primary);
    font-size: 1.3rem;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .icon-btn {
    background: none;
    border: none;
    color: var(--primary);
    font-size: 1.6rem;
    cursor: pointer;
    transition: transform 0.2s ease, color 0.2s ease;
  }

  .icon-btn:hover {
    transform: scale(1.1);
    color: var(--secondary);
  }

  .icon-btn[title] {
    position: relative;
  }

  .icon-btn[title]::after {
    content: attr(title);
    position: absolute;
    bottom: -1.8rem;
    left: 50%;
    transform: translateX(-50%);
    background: rgba(0,0,0,0.75);
    color: white;
    font-size: 0.7rem;
    padding: 3px 6px;
    border-radius: 4px;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.2s ease;
    white-space: nowrap;
  }

  .icon-btn:hover::after {
    opacity: 1;
  }

  .filters {
    margin-top: 70px;
  }

  /* === BOT√ìN PAYPAL FLOTANTE === */
  .donate-floating-btn {
    display: none;
    position: fixed;
    bottom: 20px;
    right: 20px;
    width: 55px;
    height: 55px;
    background: linear-gradient(135deg, var(--secondary), var(--primary));
    color: white;
    border-radius: 50%;
    box-shadow: 0 5px 20px rgba(0,0,0,0.3);
    font-size: 1.6rem;
    border: none;
    cursor: pointer;
    z-index: 1100;
    animation: bounceIn 0.8s ease forwards;
  }

  @keyframes bounceIn {
    0% { transform: scale(0.2); opacity: 0; }
    60% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); }
  }

  .donate-floating-btn:hover {
    transform: scale(1.1);
    box-shadow: 0 8px 25px rgba(0,0,0,0.35);
  }

  @media (max-width: 768px) {
    #donateBtn { display: none; } /* Oculta el del header */
    .donate-floating-btn { display: flex; justify-content: center; align-items: center; }
  }

  /* --- MODAL DONACIONES --- */
  .donate-modal {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.4);
    backdrop-filter: blur(4px);
    justify-content: center;
    align-items: center;
    z-index: 1200;
  }

  .donate-modal.active {
    display: flex;
  }

  .donate-modal-content {
    background: white;
    padding: 2rem;
    border-radius: 20px;
    max-width: 400px;
    width: 90%;
    text-align: center;
    color: var(--text-color);
    box-shadow: 0 6px 25px rgba(0,0,0,0.15);
    animation: fadeInUp 0.3s ease;
  }

  @keyframes fadeInUp {
    from { transform: translateY(40px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
  }

  .donate-modal select {
    width: 100%;
    margin: 1rem 0;
    padding: 0.6rem;
    border-radius: 10px;
    border: 2px solid var(--secondary);
    font-size: 1rem;
  }

  .donate-buttons {
    display: flex;
    justify-content: center;
    margin-top: 1rem;
  }

  .donate-buttons .cancel {
    background: #ccc;
    border: none;
    padding: 0.6rem 1.2rem;
    border-radius: 10px;
    cursor: pointer;
  }

  .donate-buttons .cancel:hover {
    background: #bbb;
  }
  </style>

  <!-- PayPal SDK -->
  <script src="https://www.paypal.com/sdk/js?client-id=YOUR_CLIENT_ID&currency=USD"></script>
</head>

<body>
  <!-- Fondo animado -->
  <div class="background">
    <div class="bubble"></div><div class="bubble"></div><div class="bubble"></div>
    <div class="bubble"></div><div class="bubble"></div>
  </div>

  <header>
    <h1><img src="img/logo.png" alt="logo" style="height:38px;"> My Store</h1>
    <div class="header-actions">
      <button id="adminPanelBtn" class="icon-btn" title="Panel Admin" style="display:none;">
        <i class="fa-solid fa-gear"></i>
      </button>
      <button id="donateBtn" class="icon-btn" title="Donar con PayPal">
        <i class="fa-brands fa-paypal"></i>
      </button>
      <button id="authBtn" class="icon-btn" title="Iniciar sesi√≥n">
        <i class="fa-solid fa-right-to-bracket"></i>
      </button>
    </div>
  </header>

  <section class="filters fade-in">
    <input type="text" id="searchInput" placeholder="Buscar app..." />
    <select id="categoryFilter"><option value="">Todas las Categor√≠as</option></select>
    <select id="priceFilter">
      <option value="">Todas</option><option value="free">Gratis</option><option value="paid">De pago</option>
    </select>
  </section>

  <section class="app-grid" id="appGrid"></section>

  <footer>
    <p><strong>¬© 2025 My Store</strong></p>
    <p>Soporte: <a href="mailto:soportemyestore@gmail.com">soportemyestore@gmail.com</a></p>
    <p><img src="img/whatsapp.svg" style="width:13px;"> <a href="https://wa.me/573013150359" target="_blank">+57 301 315 0359</a></p>
  </footer>

  <!-- BOT√ìN PAYPAL FLOTANTE -->
  <button id="floatingDonateBtn" class="donate-floating-btn" title="Donar con PayPal">
    <i class="fa-brands fa-paypal"></i>
  </button>

  <!-- MODAL DONACIONES -->
  <div class="donate-modal" id="donateModal">
    <div class="donate-modal-content">
      <h3>üíú Apoya el proyecto</h3>
      <p>Selecciona un monto de donaci√≥n:</p>
      <select id="donationAmount">
        <option value="1">$1 USD</option>
        <option value="5">$5 USD</option>
        <option value="10">$10 USD</option>
        <option value="15">$15 USD</option>
        <option value="20">$20 USD</option>
        <option value="custom">Otro monto</option>
      </select>
      <div id="paypal-button-container"></div>
      <div class="donate-buttons">
        <button class="cancel" id="cancelDonate">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- MODAL LOGOUT -->
  <div class="logout-modal" id="logoutModal">
    <div class="logout-modal-content card fade-in">
      <h3>¬øDeseas cerrar sesi√≥n?</h3>
      <p>Tu sesi√≥n actual se cerrar√° y deber√°s volver a iniciar sesi√≥n.</p>
      <div class="logout-buttons">
        <button id="confirmLogout" class="btn">S√≠</button>
        <button id="cancelLogout" class="btn cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
  // Header efecto scroll
  window.addEventListener("scroll", () => {
    document.querySelector("header").classList.toggle("scrolled", window.scrollY > 50);
  });

  // Fondo animado
  const bubbles = document.querySelector(".background");
  for (let i = 0; i < 10; i++) {
    const b = document.createElement("div");
    b.classList.add("bubble");
    b.style.width = b.style.height = Math.random() * 80 + 40 + "px";
    b.style.left = Math.random() * 100 + "%";
    b.style.animationDelay = Math.random() * 8 + "s";
    bubbles.appendChild(b);
  }

  const appGrid = document.getElementById("appGrid");
  const searchInput = document.getElementById("searchInput");
  const categoryFilter = document.getElementById("categoryFilter");
  const priceFilter = document.getElementById("priceFilter");
  const adminPanelBtn = document.getElementById("adminPanelBtn");
  let apps = [];

  async function loadApps() {
    const res = await fetch("/api/apps");
    apps = await res.json();
    renderApps(); fillCategories();
  }

  function fillCategories() {
    const cats = [...new Set(apps.map(a => a.category).filter(Boolean))];
    cats.forEach(cat => {
      const opt = document.createElement("option");
      opt.value = cat;
      opt.textContent = cat;
      categoryFilter.appendChild(opt);
    });
  }

  function renderStars(r) {
    return "‚òÖ".repeat(Math.round(r)) + "‚òÜ".repeat(5 - Math.round(r));
  }

  function renderApps() {
    const search = searchInput.value.toLowerCase();
    const cat = categoryFilter.value;
    const price = priceFilter.value;
    const filtered = apps.filter(a =>
      a.name.toLowerCase().includes(search) &&
      (!cat || a.category === cat) &&
      (!price || (price === "free" && !a.is_paid) || (price === "paid" && a.is_paid))
    );
    appGrid.innerHTML = "";
    filtered.forEach(a => {
      const card = document.createElement("div");
      card.classList.add("app-card", "fade-in");
      card.onclick = () => window.location.href = `app-details.html?id=${a.id}`;
      const priceLabel = a.is_paid ? `$${parseFloat(a.price).toFixed(2)}` : "Gratis";
      card.innerHTML = `
        <div class="badge-price ${a.is_paid ? '' : 'free'}">${priceLabel}</div>
        <img src="${a.image}" alt="${a.name}" />
        <div class="app-info">
          <h3>${a.name}</h3>
          <div class="stars">${renderStars(a.average_rating || 0)}</div>
        </div>`;
      appGrid.appendChild(card);
    });
  }

  searchInput.addEventListener("input", renderApps);
  categoryFilter.addEventListener("change", renderApps);
  priceFilter.addEventListener("change", renderApps);
  loadApps();

  // Sesi√≥n + roles
  async function checkSession() {
    try {
      const res = await fetch("/api/session");
      const data = await res.json();
      const authBtn = document.getElementById("authBtn");

      if (data.loggedIn) {
        authBtn.title = "Cerrar sesi√≥n";
        authBtn.innerHTML = `<i class="fa-solid fa-right-from-bracket"></i>`;
        authBtn.onclick = () => document.getElementById("logoutModal").classList.add("active");
        if (data.user?.role === "admin") {
          adminPanelBtn.style.display = "inline";
          adminPanelBtn.onclick = () => window.location.href = "/admin.html";
        }
      } else {
        authBtn.title = "Iniciar sesi√≥n";
        authBtn.innerHTML = `<i class="fa-solid fa-right-to-bracket"></i>`;
        authBtn.onclick = () => window.location.href = "login.html";
        adminPanelBtn.style.display = "none";
      }
    } catch (err) { console.error("Error comprobando sesi√≥n:", err); }
  }
  checkSession();

  // Logout modal
  document.getElementById("cancelLogout").onclick = () => document.getElementById("logoutModal").classList.remove("active");
  document.getElementById("confirmLogout").onclick = async () => {
    const logout = await fetch("/logout", { method: "POST" });
    if (logout.ok) window.location.reload();
  };

  // Donaci√≥n modal
  const donateModal = document.getElementById("donateModal");
  const openDonate = () => { donateModal.classList.add("active"); renderPayPalButton(); };
  document.getElementById("donateBtn").onclick = openDonate;
  document.getElementById("floatingDonateBtn").onclick = openDonate;
  document.getElementById("cancelDonate").onclick = () => donateModal.classList.remove("active");

  function renderPayPalButton() {
    const amountSelect = document.getElementById("donationAmount");
    const container = document.getElementById("paypal-button-container");
    container.innerHTML = "";
    paypal.Buttons({
      style: { color: "blue", shape: "pill", label: "paypal", height: 40 },
      createOrder: (data, actions) => {
        let amount = amountSelect.value === "custom" ? prompt("Ingrese monto en USD:") : amountSelect.value;
        if (!amount || isNaN(amount) || amount <= 0) amount = 1;
        return actions.order.create({ purchase_units: [{ amount: { value: parseFloat(amount).toFixed(2) } }] });
      },
      onApprove: async (data, actions) => {
        const order = await actions.order.capture();
        alert(`‚úÖ ¬°Gracias por tu donaci√≥n de $${order.purchase_units[0].amount.value}!`);
        donateModal.classList.remove("active");
      },
      onError: (err) => {
        console.error("Error en PayPal:", err);
        alert("‚ùå Error al procesar la donaci√≥n.");
      }
    }).render("#paypal-button-container");
  }
  </script>
</body>
</html>
