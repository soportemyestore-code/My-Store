<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Store | Tienda de Apps</title>
  <link rel="icon" href="img/logo.png" type="image/png">
  <link rel="stylesheet" href="styles/styles.css">
  <link rel="stylesheet" href="styles/animations.css">
  <!--<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">-->

  <style>
  /* === STYLES OMITED FOR BREVITY - KEEP YOUR ORIGINAL STYLES === */
  /* (You already have these in your repo. Kept minimal here.) */
  </style>

  <!-- PayPal SDK - use LIVE client-id in production environment variable or replace here for quick test -->
  <script src="https://www.paypal.com/sdk/js?client-id=ATX96RIoBXU4b82Z-ugIrWQV4CCKh3-yI_JONnuzzy9EsKsAUl8qH5D2BhzBT_JAUzg67iMp0MCmavon&currency=USD"></script>
</head>
<body>
  <!-- CONTENT (kept same structure) -->
  <header>...</header>

  <section class="filters fade-in">
    <input type="text" id="searchInput" placeholder="Buscar app..." />
    <select id="categoryFilter"><option value="">Todas las CategorÃ­as</option></select>
    <select id="priceFilter"><option value="">Todas</option><option value="free">Gratis</option><option value="paid">De pago</option></select>
  </section>

  <section class="app-grid" id="appGrid"></section>

  <footer>...</footer>

  <!-- boton flotante -->
  <button id="floatingDonateBtn" class="donate-floating-btn" title="Donar con PayPal"><i class="fa-brands fa-paypal"></i></button>

  <!-- modal donaciones -->
  <div class="donate-modal" id="donateModal" aria-hidden="true">
    <div class="donate-modal-content" role="dialog" aria-modal="true" aria-labelledby="donateTitle">
      <h3 id="donateTitle">ðŸ’œ Apoya el proyecto</h3>
      <p>Selecciona un monto:</p>
      <select id="donationAmount" aria-label="Monto de donaciÃ³n">
        <option value="1">$1 USD</option>
        <option value="5">$5 USD</option>
        <option value="10">$10 USD</option>
        <option value="15">$15 USD</option>
        <option value="20">$20 USD</option>
        <option value="custom">Otro monto</option>
      </select>
      <div id="paypal-button-container" style="margin-top:14px;"></div>
      <div class="donate-buttons"><button id="cancelDonate" class="btn cancel">Cancelar</button></div>
      <div id="donateStatus" style="margin-top:10px;color:#333;"></div>
    </div>
  </div>

  <!-- modal logout -->
  <div class="logout-modal" id="logoutModal">...</div>

  <script>
  // Minimal UI scripts (keep your original app code intact).
  // PayPal donation handling - corrected to avoid popup blocked issues.
  (function(){
    const donateTrigger = document.getElementById('floatingDonateBtn');
    const donateModal = document.getElementById('donateModal');
    const cancelBtn = document.getElementById('cancelDonate');
    const paypalContainer = document.getElementById('paypal-button-container');
    const donateStatus = document.getElementById('donateStatus');
    let paypalRendered = false;

    // Helper to show modal without animations (to avoid popup block)
    function showModal() {
      donateModal.style.display = 'flex';
      donateModal.setAttribute('aria-hidden', 'false');
    }
    function hideModal() {
      donateModal.style.display = 'none';
      donateModal.setAttribute('aria-hidden', 'true');
    }

    // Render PayPal buttons ON DEMAND (synchronously during click)
    function renderPayPalButtonsOnce() {
      if (paypalRendered) return;
      paypalRendered = true;

      paypal.Buttons({
        style: { layout: 'vertical', color: 'gold', shape: 'pill', label: 'paypal' },

        createOrder: function(data, actions) {
          const amountSelect = document.getElementById('donationAmount');
          let amount = amountSelect.value;
          if (amount === 'custom') {
            amount = prompt('Ingresa el monto en USD:');
            if (!amount || isNaN(amount)) {
              donateStatus.textContent = 'Monto invÃ¡lido.';
              throw new Error('Invalid amount');
            }
          }
          donateStatus.textContent = 'Creando orden...';

          // IMPORTANT: use relative API calls to your backend. This keeps Client ID secret handling in server.
          return fetch('/api/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ amount: Number(amount).toFixed(2) })
          }).then(res => {
            if (!res.ok) throw new Error('Error creando orden');
            return res.json();
          }).then(data => {
            donateStatus.textContent = '';
            // PayPal SDK expects the order ID in the response.id
            return data.id;
          }).catch(err => {
            donateStatus.textContent = 'No se pudo crear la orden. Intenta mÃ¡s tarde.';
            console.error('createOrder error', err);
            throw err;
          });
        },

        onApprove: function(data, actions) {
          donateStatus.textContent = 'Capturando pago...';
          return fetch(`/api/orders/${data.orderID}/capture`, { method: 'POST' })
            .then(res => res.json())
            .then(details => {
              donateStatus.textContent = 'Â¡Gracias por tu apoyo!';
              setTimeout(()=> hideModal(), 900);
            }).catch(err => {
              donateStatus.textContent = 'Error al completar el pago.';
              console.error('capture error', err);
            });
        },

        onError: function(err) {
          donateStatus.textContent = 'Error con PayPal.';
          console.error('PayPal Buttons error', err);
        }

      }).render('#paypal-button-container');
    }

    // Open modal handler - MUST render buttons synchronously to avoid popup block
    donateTrigger.addEventListener('click', function onClick(e){
      // show modal immediately (no animation)
      showModal();

      // render buttons synchronously
      try {
        renderPayPalButtonsOnce();
      } catch (err) {
        console.error('render error', err);
      }
    });

    cancelBtn.addEventListener('click', hideModal);

    // Accessibility: close modal on Escape
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') hideModal();
    });

    // In case the modal is closed externally, ensure next open reuses rendered buttons
    donateModal.addEventListener('click', (e)=> {
      if (e.target === donateModal) hideModal();
    });
  })();
  </script>
</body>
</html>

