<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Store | Tienda de Apps</title>
  <link rel="icon" href="img/logo.png" type="image/png">

  <!-- Tus hojas de estilo originales -->
  <link rel="stylesheet" href="styles/styles.css">
  <link rel="stylesheet" href="styles/animations.css">

  <!-- Font Awesome (si Tracking Prevention lo bloquea, hay fallback visual en botones) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="" crossorigin="anonymous" />

  <style>
    /* Peque√±os ajustes/local overrides sin tocar tu styles.css */
    header {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      background: rgba(255,255,255,0.88);
      backdrop-filter: blur(12px);
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.8rem 1.2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      z-index: 1000;
    }
    header h1 {
      color: var(--primary);
      font-size: 1.25rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: .6rem;
    }
    /* acciones header: donate visible en desktop, oculto en m√≥vil */
    .header-actions { display:flex; align-items:center; gap:0.8rem; }
    #donateHeaderBtn { display:inline-flex; gap:.5rem; align-items:center; }
    @media (max-width: 768px) {
      #donateHeaderBtn { display:none; } /* donate header oculto en m√≥vil */
    }

    /* Bot√≥n flotante Auth (derecha) */
    .auth-floating-btn {
      display: none;
      position: fixed;
      bottom: 20px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg,var(--secondary),var(--primary));
      color: white;
      border: none;
      box-shadow: 0 8px 30px rgba(0,0,0,0.25);
      z-index: 1100;
      cursor: pointer;
      justify-content: center;
      align-items: center;
      font-size: 1.25rem;
      animation: authIn 0.7s ease both;
    }
    @keyframes authIn { 0%{ transform: scale(.2); opacity:0 } 60%{ transform: scale(1.12); opacity:1 } 100%{ transform: scale(1) } }
    .auth-floating-btn:hover { transform: scale(1.06); }

    /* Bot√≥n flotante Donate (izquierda) - solo en m√≥vil se muestra */
    .donate-floating-btn {
      display: none;
      position: fixed;
      bottom: 20px;
      left: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(135deg,#00c853,#43a047);
      color: white;
      border: none;
      box-shadow: 0 8px 30px rgba(0,0,0,0.25);
      z-index: 1100;
      cursor: pointer;
      justify-content: center;
      align-items: center;
      font-size: 1.25rem;
      animation: donateIn 0.7s ease both;
    }
    @keyframes donateIn { 0%{ transform: translateY(20px) scale(.3); opacity:0 } 60%{ transform: translateY(-6px) scale(1.05); opacity:1 } 100%{ transform: translateY(0) scale(1) } }
    .donate-floating-btn:hover { transform: scale(1.06); }

    @media (max-width: 768px) {
      .auth-floating-btn { display:flex; }
      .donate-floating-btn { display:flex; }
    }

    /* peque√±o badge admin en el auth-floating cuando user = admin */
    .admin-badge {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      background: #ffdd57;
      color: #441a82;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size: 0.75rem;
      font-weight:700;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }

    /* Aseguramos que footer se muestre sobre el fondo animado */
    footer { position: relative; z-index: 10; }

    /* mantengo estilos para paypal button container dentro del modal */
    #paypal-button-container { display:flex; justify-content:center; margin-top:10px; }
  </style>

  <!-- PayPal SDK con tu Client ID (sandbox/live seg√∫n tu ID) -->
  <script src="https://www.paypal.com/sdk/js?client-id=AZDkkap379fIWhWg3iADt9MbiB3ZlnCGPcM96FyijbeFdd9TtVxXHmVWenxhNfcSn6LCSj0ZhjptOKpG&currency=USD"></script>
</head>
<body>
  <!-- Fondo animado (usa tu styles.css) -->
  <div class="background" aria-hidden="true">
    <div class="bubble"></div><div class="bubble"></div><div class="bubble"></div><div class="bubble"></div><div class="bubble"></div>
  </div>

  <!-- HEADER -->
  <header>
    <h1><img src="img/logo.png" alt="logo" style="height:40px;"> My Store</h1>

    <div class="header-actions">
      <!-- Donate button visible en desktop -->
      <button id="donateHeaderBtn" class="login-btn" title="Donar con PayPal">
        <i class="fa-brands fa-paypal" aria-hidden="true"></i>
        <span style="margin-left:6px; font-weight:600; font-size:.95rem;">Donar</span>
      </button>

      <!-- Admin button (solo se muestra si role === 'admin') -->
      <button id="adminBtn" class="login-btn" style="display:none;" title="Panel Admin">
        <i class="fa-solid fa-gear" aria-hidden="true"></i>
      </button>

      <!-- (Dejamos el header ligero ‚Äî el auth est√° en el flotante) -->
    </div>
  </header>

  <!-- FILTROS (id√©nticos a tu versi√≥n) -->
  <section class="filters fade-in" aria-label="Filtros">
    <input type="text" id="searchInput" placeholder="Buscar app..." />
    <select id="categoryFilter" aria-label="Categor√≠a">
      <option value="">Todas las Categor√≠as</option>
    </select>
    <select id="priceFilter" aria-label="Precio">
      <option value="">Todas</option>
      <option value="free">Gratis</option>
      <option value="paid">De pago</option>
    </select>
  </section>

  <!-- GRID DE APPS (uso tus clases y estilos) -->
  <section class="app-grid" id="appGrid" aria-live="polite"></section>

  <!-- FOOTER (asegurado sobre el fondo) -->
  <footer class="fade-in">
    <p><strong>¬© 2025 My Store</strong></p>
    <p>Soporte y atenci√≥n: <a href="mailto:soportemyestore@gmail.com">soportemyestore@gmail.com</a></p>
    <p><img src="img/whatsapp.svg" alt="whatsapp" style="width:13px;"> <a href="https://wa.me/573013150359" target="_blank" rel="noopener">+57 301 315 0359</a></p>
  </footer>

  <!-- BOT√ìN FLOTANTE: AUTH (derecha) -->
  <button id="authFloatingBtn" class="auth-floating-btn" title="Iniciar sesi√≥n">
    <!-- icono por defecto (fallback en caso de CDN bloqueado es texto) -->
    <i id="authFloatingIcon" class="fa-solid fa-right-to-bracket" aria-hidden="true"></i>
    <!-- admin badge a√±adido din√°micamente cuando el user sea admin -->
  </button>

  <!-- BOT√ìN FLOTANTE: DONATE (izquierda en m√≥vil) -->
  <button id="donateFloatingBtn" class="donate-floating-btn" title="Donar">
    <i class="fa-brands fa-paypal" aria-hidden="true"></i>
  </button>

  <!-- MODAL: DONACIONES (glass UI) -->
  <div class="logout-modal donate-modal" id="donateModal" aria-hidden="true">
    <div class="logout-modal-content donate-modal-content card fade-in" role="dialog" aria-modal="true" aria-labelledby="donateTitle">
      <h3 id="donateTitle">üíú Apoya nuestro proyecto</h3>
      <p>Selecciona un monto o ingresa otro valor ($ USD)</p>

      <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:center; margin-top:12px;">
        <button class="amount-btn" data-amount="1">$1</button>
        <button class="amount-btn" data-amount="5">$5</button>
        <button class="amount-btn" data-amount="10">$10</button>
        <button class="amount-btn" data-amount="15">$15</button>
        <button class="amount-btn" data-amount="20">$20</button>
      </div>

      <input id="customAmount" type="number" min="1" placeholder="Otro valor ($)" style="margin-top:12px; padding:8px; width:70%; border-radius:10px; border:1px solid #ddd; text-align:center;">

      <div id="paypal-button-container"></div>

      <div class="logout-buttons" style="margin-top:16px;">
        <button id="closeDonate" class="btn cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- MODAL: LOGOUT -->
  <div class="logout-modal" id="logoutModal" aria-hidden="true">
    <div class="logout-modal-content card fade-in" role="dialog" aria-modal="true" aria-labelledby="logoutTitle">
      <h3 id="logoutTitle">¬øDeseas cerrar sesi√≥n?</h3>
      <p>Tu sesi√≥n actual se cerrar√° y deber√°s volver a iniciar sesi√≥n para continuar.</p>
      <div class="logout-buttons">
        <button id="confirmLogout" class="btn">S√≠, cerrar sesi√≥n</button>
        <button id="cancelLogout" class="btn cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
  /* ========== Comportamiento y l√≥gica ========== */

  // utilidades
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));

  // elementos principales
  const appGrid = $('#appGrid');
  const searchInput = $('#searchInput');
  const categoryFilter = $('#categoryFilter');
  const priceFilter = $('#priceFilter');

  const adminBtn = $('#adminBtn');
  const donateHeaderBtn = $('#donateHeaderBtn');
  const authFloatingBtn = $('#authFloatingBtn');
  const authFloatingIcon = $('#authFloatingIcon');
  const donateFloatingBtn = $('#donateFloatingBtn');

  const donateModal = $('#donateModal');
  const closeDonate = $('#closeDonate');
  const amountButtons = () => $$('.amount-btn');
  const customAmount = $('#customAmount');
  let selectedAmount = 5;

  let apps = [];

  // --- helper: safe fetch with timeout (to help detectar 400/500) ---
  async function safeFetch(url, opts = {}) {
    try {
      const res = await fetch(url, opts);
      return res;
    } catch (err) {
      console.error('Fetch error', url, err);
      throw err;
    }
  }

  // --- Cargar apps (robusto) ---
  async function loadApps() {
    try {
      const res = await safeFetch('/api/apps');
      if (!res.ok) {
        console.warn('/api/apps responded with', res.status);
        appGrid.innerHTML = `<div class="load-error">No se pudieron cargar las apps (error ${res.status}). Revisa el servidor.</div>`;
        return;
      }
      apps = await res.json();
      renderApps();
      fillCategories();
    } catch (err) {
      appGrid.innerHTML = `<div class="load-error">Error de red al cargar apps. Revisa la consola.</div>`;
    }
  }

  function fillCategories() {
    categoryFilter.innerHTML = '<option value="">Todas las Categor√≠as</option>';
    const cats = [...new Set(apps.map(a => a.category).filter(Boolean))];
    cats.forEach(cat => {
      const opt = document.createElement('option');
      opt.value = cat;
      opt.textContent = cat;
      categoryFilter.appendChild(opt);
    });
  }

  function renderStars(rating) {
    const n = Math.round(rating || 0);
    return '‚òÖ'.repeat(n) + '‚òÜ'.repeat(Math.max(0,5-n));
  }

  function renderApps() {
    const search = (searchInput.value || '').toLowerCase();
    const cat = categoryFilter.value;
    const price = priceFilter.value;

    const filtered = apps.filter(a => {
      const matchesSearch = (a.name || '').toLowerCase().includes(search);
      const matchesCat = !cat || a.category === cat;
      const matchesPrice = !price || (price === 'free' && !a.is_paid) || (price === 'paid' && a.is_paid);
      return matchesSearch && matchesCat && matchesPrice;
    });

    appGrid.innerHTML = '';
    if (!filtered.length) {
      appGrid.innerHTML = `<div class="load-error">No se encontraron apps con esos filtros.</div>`;
      return;
    }

    filtered.forEach(a => {
      const card = document.createElement('div');
      card.className = 'app-card fade-in';
      card.onclick = () => window.location.href = `app-details.html?id=${a.id}`;
      const priceLabel = a.is_paid ? `$${parseFloat(a.price).toFixed(2)}` : 'Gratis';
      card.innerHTML = `
        <div class="badge-price ${a.is_paid ? '' : 'free'}">${priceLabel}</div>
        <img src="${a.image || 'img/default-app.png'}" alt="${(a.name||'App')}" />
        <div class="app-info">
          <h3 class="app-title">${a.name || 'App sin nombre'}</h3>
          <div class="stars">${renderStars(a.average_rating || 0)}</div>
        </div>
      `;
      appGrid.appendChild(card);
    });
  }

  // eventos filtros
  searchInput.addEventListener('input', renderApps);
  categoryFilter.addEventListener('change', renderApps);
  priceFilter.addEventListener('change', renderApps);

  // inicias carga de apps
  loadApps();

  /* ===== Session / Auth / Admin button ===== */
  async function checkSession() {
    try {
      const res = await safeFetch('/api/session');
      if (!res.ok) {
        console.warn('checkSession returned', res.status);
        setAuthUINotLogged();
        return;
      }
      const data = await res.json();
      // backend puede devolver { loggedIn: true, role: 'admin' } o { loggedIn: true, user: { role: 'admin' } }
      const role = data.role || (data.user && data.user.role);
      if (data.loggedIn) setAuthUILogged(role, data);
      else setAuthUINotLogged();
    } catch (err) {
      console.error('checkSession error', err);
      setAuthUINotLogged();
    }
  }

  function setAuthUILogged(role, data) {
    // auth floating -> muestra icono logout
    authFloatingIcon.className = 'fa-solid fa-right-from-bracket';
    authFloatingBtn.title = 'Cerrar sesi√≥n';
    authFloatingBtn.onclick = () => document.getElementById('logoutModal').classList.add('active');

    // admin: mostrar boton en header y badge en el floating
    if (role === 'admin') {
      adminBtn.style.display = 'inline-block';
      adminBtn.onclick = () => window.location.href = '/admin-panel.html';

      // agrega badge si no existe
      if (!authFloatingBtn.querySelector('.admin-badge')) {
        const b = document.createElement('div');
        b.className = 'admin-badge';
        b.textContent = 'A';
        authFloatingBtn.appendChild(b);
      }
    } else {
      adminBtn.style.display = 'none';
      const existing = authFloatingBtn.querySelector('.admin-badge');
      if (existing) existing.remove();
    }

    // logout modal actions
    $('#confirmLogout').onclick = async () => {
      try {
        const out = await fetch('/logout', { method: 'POST' });
        if (out.ok) window.location.reload();
        else alert('No se pudo cerrar sesi√≥n.');
      } catch (e) { console.error('logout error', e); alert('Error al cerrar sesi√≥n.'); }
    };
    $('#cancelLogout').onclick = () => document.getElementById('logoutModal').classList.remove('active');
  }

  function setAuthUINotLogged() {
    authFloatingIcon.className = 'fa-solid fa-right-to-bracket';
    authFloatingBtn.title = 'Iniciar sesi√≥n';
    authFloatingBtn.onclick = () => window.location.href = '/login.html';
    adminBtn.style.display = 'none';
    const existing = authFloatingBtn.querySelector('.admin-badge');
    if (existing) existing.remove();
  }

  // Ejecutar checkSession
  checkSession();

  /* ===== Donaciones (modal + PayPal) ===== */
  function openDonateModal() {
    donateModal.classList.add('active');
    // marcar default amount
    selectedAmount = 5;
    amountButtons().forEach(b => b.classList.toggle('active', b.dataset.amount == selectedAmount));
    customAmount.value = '';
    renderPayPalButton(selectedAmount);
  }

  // abrir desde header (desktop)
  donateHeaderBtn.addEventListener('click', openDonateModal);
  // abrir desde floating button (mobile)
  donateFloatingBtn.addEventListener('click', openDonateModal);
  closeDonate.addEventListener('click', () => donateModal.classList.remove('active'));

  // amount button handlers
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.amount-btn');
    if (!btn) return;
    amountButtons().forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    selectedAmount = parseFloat(btn.dataset.amount) || 5;
    customAmount.value = '';
    renderPayPalButton(selectedAmount);
  });

  customAmount.addEventListener('input', (e) => {
    const v = parseFloat(e.target.value);
    if (!isNaN(v) && v >= 1) {
      selectedAmount = v;
      amountButtons().forEach(b => b.classList.remove('active'));
      renderPayPalButton(selectedAmount);
    }
  });

  function renderPayPalButton(amount) {
    const container = document.getElementById('paypal-button-container');
    container.innerHTML = '';
    if (typeof paypal === 'undefined') {
      container.innerHTML = '<div class="load-error">PayPal SDK no disponible. Revisa el Client ID o la conexi√≥n.</div>';
      return;
    }

    paypal.Buttons({
      style: { shape: 'pill', color: 'blue', label: 'paypal', height: 40 },
      createOrder: (data, actions) => {
        const value = (typeof amount === 'number') ? amount : parseFloat(amount) || 1;
        return actions.order.create({
          purchase_units: [{ amount: { value: value.toFixed(2) } }]
        });
      },
      onApprove: async (data, actions) => {
        try {
          const order = await actions.order.capture();
          const paid = order.purchase_units?.[0]?.amount?.value || (selectedAmount || 0).toFixed(2);
          alert(`‚úÖ ¬°Gracias por tu donaci√≥n de $${paid}!`);
          donateModal.classList.remove('active');
        } catch (err) {
          console.error('capture error', err);
          alert('Ocurri√≥ un error al completar la donaci√≥n.');
        }
      },
      onError: (err) => {
        console.error('PayPal error', err);
        alert('Ocurri√≥ un error con PayPal. Revisa la consola.');
      }
    }).render('#paypal-button-container');
  }

  // Accessibility: close modals with ESC
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      donateModal.classList.remove('active');
      document.getElementById('logoutModal').classList.remove('active');
    }
  });

  // Ready.
  </script>
</body>
</html>
