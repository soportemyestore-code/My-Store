<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>My Store | Tienda de Apps</title>
  <link rel="icon" href="img/logo.png" type="image/png">
  <link rel="stylesheet" href="styles/styles.css">
  <link rel="stylesheet" href="styles/animations.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
  /* === HEADER === */
  header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    background: rgba(255,255,255,0.88);
    backdrop-filter: blur(12px);
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:0.7rem 1.2rem;
    box-shadow:0 2px 10px rgba(0,0,0,0.08);
    z-index:1000;
  }
  header h1{ color:var(--primary); font-size:1.3rem; font-weight:600; display:flex; align-items:center; gap:.5rem;}
  .icon-btn{ background:none; border:none; color:var(--primary); font-size:1.5rem; cursor:pointer; transition: transform .18s ease, color .18s ease;}
  .icon-btn:hover{ transform:scale(1.08); color:var(--secondary); }

  /* === FILTROS (aseguramos espacio bajo header) === */
  .filters {
    display:flex;
    flex-wrap:wrap;
    justify-content:center;
    gap:1rem;
    padding:1.2rem 1rem;
    margin-top:78px; /* espacio para header fijo */
    background: rgba(255,255,255,0.6);
    backdrop-filter: blur(10px);
    border-bottom:2px solid rgba(0,0,0,0.04);
    position:relative;
    z-index:900;
  }
  .filters input, .filters select {
    border: 2px solid #b5179e30;
    border-radius:10px;
    padding:.7rem .9rem;
    font-size:1rem;
    background:rgba(255,255,255,0.85);
    color:var(--text-color);
  }

  /* === GRID DE APPS (restaurado) === */
  .app-grid {
    display:grid;
    grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
    gap: 1rem;
    padding: 1rem;
    max-width:1100px;
    margin: 1rem auto 3rem;
    position:relative;
    z-index:10;
  }
  @media (min-width:600px) {
    .app-grid { grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); }
  }

  /* === APP CARD (restaurado) === */
  .app-card {
    background: rgba(255,255,255,0.92);
    border-radius:16px;
    box-shadow: 0 6px 20px rgba(0,0,0,0.06);
    overflow:hidden;
    text-align:center;
    transition: transform .22s ease, box-shadow .22s ease;
    cursor:pointer;
    padding-bottom: .6rem;
  }
  .app-card:hover { transform: translateY(-6px); box-shadow:0 12px 30px rgba(0,0,0,0.12); }
  .app-card img { width:100%; aspect-ratio:1/1; object-fit:cover; border-bottom:2px solid var(--primary); display:block; }
  .app-card .app-info { padding:12px; color:var(--text-color); }
  .app-card h3{ font-size:1rem; margin-top:0.4rem; }
  .stars{ color:#fbbf24; margin-top:0.25rem; }

  /* === BADGE PRICE (mantener) === */
  .badge-price { position:absolute; top:10px; right:10px; background: linear-gradient(135deg, var(--secondary), var(--primary)); color:var(--text-light); font-size:.85rem; font-weight:600; padding:6px 12px; border-radius:30px; box-shadow:0 2px 10px rgba(0,0,0,0.12); z-index:3; pointer-events:none; transition: transform .18s ease; }
  .badge-price.free { background: linear-gradient(135deg,#00c853,#43a047); }

  /* === BOT√ìN FLOTANTE PAYPAL === */
  .donate-floating-btn {
    display:none;
    position:fixed; bottom:20px; right:20px;
    width:56px; height:56px; border-radius:50%;
    background: linear-gradient(135deg,var(--secondary),var(--primary));
    color:white; border:none; font-size:1.5rem; cursor:pointer;
    box-shadow:0 8px 30px rgba(0,0,0,0.25); z-index:1100;
    animation: bounceIn .7s ease both;
    justify-content:center; align-items:center;
  }
  @keyframes bounceIn { 0%{ transform: scale(.2); opacity:0 } 60%{ transform: scale(1.15); opacity:1 } 100%{ transform: scale(1) } }
  .donate-floating-btn:hover{ transform:scale(1.06); }

  @media (max-width:768px) {
    #donateBtn { display:none; }
    .donate-floating-btn { display:flex; }
  }

  /* === MODALES (donate/logout) === */
  .logout-modal, .donate-modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.38); backdrop-filter: blur(3px); justify-content:center; align-items:center; z-index:1200; }
  .logout-modal.active, .donate-modal.active { display:flex; }
  .logout-modal-content, .donate-modal-content {
    background: rgba(255,255,255,0.97); border-radius:18px; padding:1.6rem; max-width:420px; width:92%; box-shadow:0 12px 30px rgba(0,0,0,0.16);
    animation: fadeInUp .28s ease;
  }
  @keyframes fadeInUp { from{ transform: translateY(24px); opacity:0 } to{ transform: translateY(0); opacity:1 } }

  .logout-buttons, .donate-buttons { margin-top:16px; display:flex; gap:10px; justify-content:center; }
  .btn { padding:.6rem 1rem; border-radius:10px; border:none; cursor:pointer; font-weight:600; }
  .btn.cancel { background:#ccc; color:#222; }
  .btn:hover { transform: translateY(-1px); }

  /* Mensaje de error / fallback */
  #appGrid .load-error { text-align:center; color:#a00; padding:1rem; background:#fff6f6; border-radius:8px; box-shadow:0 3px 10px rgba(0,0,0,0.04); }
  </style>
  <!-- PayPal SDK (reemplazar YOUR_CLIENT_ID) -->
  <script src="https://www.paypal.com/sdk/js?client-id=AZDkkap379fIWhWg3iADt9MbiB3ZlnCGPcM96FyijbeFdd9TtVxXHmVWenxhNfcSn6LCSj0ZhjptOKpG&currency=USD"></script>
</head>
<body>
  <!-- fondo animado -->
  <div class="background">
    <div class="bubble"></div><div class="bubble"></div><div class="bubble"></div><div class="bubble"></div><div class="bubble"></div>
  </div>

  <header>
    <h1><img src="img/logo.png" alt="logo" style="height:38px;"> My Store</h1>
    <div class="header-actions">
      <button id="adminPanelBtn" class="icon-btn" title="Panel Admin" style="display:none;"><i class="fa-solid fa-gear"></i></button>
      <button id="donateBtn" class="icon-btn" title="Donar con PayPal"><i class="fa-brands fa-paypal"></i></button>
      <button id="authBtn" class="icon-btn" title="Iniciar sesi√≥n"><i class="fa-solid fa-right-to-bracket"></i></button>
    </div>
  </header>

  <section class="filters fade-in">
    <input type="text" id="searchInput" placeholder="Buscar app..." />
    <select id="categoryFilter"><option value="">Todas las Categor√≠as</option></select>
    <select id="priceFilter"><option value="">Todas</option><option value="free">Gratis</option><option value="paid">De pago</option></select>
  </section>

  <section class="app-grid" id="appGrid"></section>

  <footer>
    <p><strong>¬© 2025 My Store</strong></p>
    <p>Soporte: <a href="mailto:soportemyestore@gmail.com">soportemyestore@gmail.com</a></p>
    <p><img src="img/whatsapp.svg" style="width:13px;"> <a href="https://wa.me/573013150359" target="_blank">+57 301 315 0359</a></p>
  </footer>

  <!-- bot√≥n flotante -->
  <button id="floatingDonateBtn" class="donate-floating-btn" title="Donar con PayPal"><i class="fa-brands fa-paypal"></i></button>

  <!-- modal donaciones -->
  <div class="donate-modal" id="donateModal">
    <div class="donate-modal-content">
      <h3>üíú Apoya el proyecto</h3>
      <p>Selecciona un monto:</p>
      <select id="donationAmount">
        <option value="1">$1 USD</option>
        <option value="5">$5 USD</option>
        <option value="10">$10 USD</option>
        <option value="15">$15 USD</option>
        <option value="20">$20 USD</option>
        <option value="custom">Otro monto</option>
      </select>
      <div id="paypal-button-container" style="margin-top:14px;"></div>
      <div class="donate-buttons"><button id="cancelDonate" class="btn cancel">Cancelar</button></div>
    </div>
  </div>

  <!-- modal logout -->
  <div class="logout-modal" id="logoutModal">
    <div class="logout-modal-content">
      <h3>¬øDeseas cerrar sesi√≥n?</h3>
      <p>Tu sesi√≥n actual se cerrar√° y deber√°s volver a iniciar sesi√≥n para continuar.</p>
      <div class="logout-buttons">
        <button id="confirmLogout" class="btn">S√≠, cerrar sesi√≥n</button>
        <button id="cancelLogout" class="btn cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <script>
  /* ==== UI din√°mico (apps, filtros, session) ==== */

  // anim header on scroll
  window.addEventListener('scroll', () => document.querySelector('header').classList.toggle('scrolled', window.scrollY > 50));

  // bubbles
  (function createBubbles(){
    const bg = document.querySelector('.background');
    for (let i=0;i<10;i++){
      const b = document.createElement('div'); b.className='bubble';
      b.style.width = b.style.height = Math.random()*80 + 40 + 'px';
      b.style.left = Math.random()*100 + '%';
      b.style.animationDelay = Math.random()*8 + 's';
      bg.appendChild(b);
    }
  })();

  const appGrid = document.getElementById('appGrid');
  const searchInput = document.getElementById('searchInput');
  const categoryFilter = document.getElementById('categoryFilter');
  const priceFilter = document.getElementById('priceFilter');
  const adminPanelBtn = document.getElementById('adminPanelBtn');
  let apps = [];

  async function loadApps(){
    try {
      const res = await fetch('/api/apps');
      if (!res.ok) {
        console.error('Error cargando /api/apps, status=', res.status);
        appGrid.innerHTML = `<div class="load-error">No se pudieron cargar las apps (error ${res.status}). Intenta recargar la p√°gina.</div>`;
        return;
      }
      apps = await res.json();
      renderApps();
      fillCategories();
    } catch (err) {
      console.error('Error fetch /api/apps:', err);
      appGrid.innerHTML = `<div class="load-error">Error de red al cargar apps. Revisa tu servidor o la conexi√≥n.</div>`;
    }
  }

  function fillCategories(){
    categoryFilter.innerHTML = '<option value="">Todas las Categor√≠as</option>';
    const cats = [...new Set(apps.map(a => a.category).filter(Boolean))];
    cats.forEach(cat=>{
      const opt = document.createElement('option'); opt.value=cat; opt.textContent=cat;
      categoryFilter.appendChild(opt);
    });
  }

  function renderStars(r){
    const round = Math.round(r || 0);
    return '‚òÖ'.repeat(round) + '‚òÜ'.repeat(Math.max(0,5-round));
  }

  function renderApps(){
    const search = (searchInput.value || '').toLowerCase();
    const cat = categoryFilter.value;
    const price = priceFilter.value;
    const filtered = apps.filter(a=>{
      const matchesSearch = (a.name || '').toLowerCase().includes(search);
      const matchesCat = !cat || a.category === cat;
      const matchesPrice = !price || (price==='free' && !a.is_paid) || (price==='paid' && a.is_paid);
      return matchesSearch && matchesCat && matchesPrice;
    });

    appGrid.innerHTML = '';
    if (!filtered.length) {
      appGrid.innerHTML = `<div class="load-error">No se encontraron apps con esos filtros.</div>`;
      return;
    }

    filtered.forEach(a=>{
      const card = document.createElement('div'); card.className = 'app-card fade-in';
      card.onclick = () => window.location.href = `app-details.html?id=${a.id}`;
      const priceLabel = a.is_paid ? `$${parseFloat(a.price).toFixed(2)}` : 'Gratis';
      card.innerHTML = `
        <div class="badge-price ${a.is_paid ? '' : 'free'}">${priceLabel}</div>
        <img src="${a.image || 'img/default-app.png'}" alt="${(a.name||'App')}" />
        <div class="app-info"><h3>${a.name||'App sin nombre'}</h3><div class="stars">${renderStars(a.average_rating||0)}</div></div>
      `;
      appGrid.appendChild(card);
    });
  }

  searchInput.addEventListener('input', renderApps);
  categoryFilter.addEventListener('change', renderApps);
  priceFilter.addEventListener('change', renderApps);
  loadApps();

  /* ==== Sesi√≥n (login/logout/admin) ==== */
  async function checkSession(){
    try {
      const res = await fetch('/api/session');
      if (!res.ok) {
        console.warn('checkSession: respuesta no OK', res.status);
        // no bloqueamos la UI; dejamos botones en modo no-login
        setAuthUINotLogged();
        return;
      }
      const data = await res.json();
      const role = data.role || (data.user && data.user.role);
      if (data.loggedIn) setAuthUILogged(role, data);
      else setAuthUINotLogged();
    } catch (err) {
      console.error('Error en checkSession:', err);
      setAuthUINotLogged();
    }
  }

  function setAuthUILogged(role, data){
    const authBtn = document.getElementById('authBtn');
    authBtn.title = 'Cerrar sesi√≥n';
    authBtn.innerHTML = `<i class="fa-solid fa-right-from-bracket"></i>`;
    authBtn.onclick = () => document.getElementById('logoutModal').classList.add('active');

    if (role === 'admin') {
      adminPanelBtn.style.display = 'inline';
      adminPanelBtn.onclick = () => window.location.href = '/admin.html';
    } else {
      adminPanelBtn.style.display = 'none';
    }

    document.getElementById('confirmLogout').onclick = async () => {
      try {
        const logout = await fetch('/logout', { method: 'POST' });
        if (logout.ok) window.location.reload();
        else alert('Error al cerrar sesi√≥n.'); 
      } catch (e) { console.error('Logout error', e); alert('Error al cerrar sesi√≥n.'); }
    };
    document.getElementById('cancelLogout').onclick = () => document.getElementById('logoutModal').classList.remove('active');
  }

  function setAuthUINotLogged(){
    const authBtn = document.getElementById('authBtn');
    authBtn.title = 'Iniciar sesi√≥n';
    authBtn.innerHTML = `<i class="fa-solid fa-right-to-bracket"></i>`;
    authBtn.onclick = () => window.location.href = 'login.html';
    adminPanelBtn.style.display = 'none';
  }

  checkSession();

  /* ==== Donaciones (PayPal) ==== */
  
const donateBtn = document.getElementById("floatingDonateBtn");
const modal = document.getElementById("donateModal");
const cancelDonate = document.getElementById("cancelDonate");
const container = document.getElementById("paypal-button-container");

let paypalRendered = false;

// 1. Abrir modal
donateBtn.addEventListener("click", () => {
  modal.style.display = "flex";
  
  // Renderizar PayPal SOLO si a√∫n no se ha renderizado
  if (!paypalRendered) {
    renderPayPalButtons();
    paypalRendered = true;
  }
});

// 2. Cerrar modal
cancelDonate.addEventListener("click", () => {
  modal.style.display = "none";
});

// 3. Funci√≥n para renderizar PayPal
function renderPayPalButtons() {

  // Limpiar botones previos si existen
  container.innerHTML = "";

  paypal.Buttons({
    style: {
      layout: "vertical",
      color: "gold",
      shape: "pill",
      label: "paypal"
    },

    createOrder: function(data, actions) {
      const amountSelect = document.getElementById("donationAmount");
      let amount = amountSelect.value;

      if (amount === "custom") {
        amount = prompt("Ingresa el monto en USD:");
      }

      return actions.order.create({
        purchase_units: [{
          amount: { value: amount }
        }]
      });
    },

    onApprove: function(data, actions) {
      return actions.order.capture().then(function(details) {
        alert("¬°Gracias por tu apoyo!");
        modal.style.display = "none";
      });
    },

    onError: function(err) {
      console.error("PayPal Error:", err);
      alert("Ocurri√≥ un error con PayPal.");
    }

  }).render("#paypal-button-container");
}

  </script>
</body>
</html>

