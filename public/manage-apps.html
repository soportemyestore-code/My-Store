<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestionar Aplicaciones - My Store (PRO)</title>
  <link rel="stylesheet" href="styles-admin.css" />
  <style>
    /* üîπ Ajustes visuales espec√≠ficos de esta p√°gina */
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      padding: 20px 8%;
      z-index: 5;
      position: relative;
    }
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    input, select, textarea {
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid rgba(0, 0, 0, 0.1);
      font-size: 0.95rem;
    }
    .btn, .tiny-btn {
      background: var(--primary);
      color: var(--text-light);
      border: none;
      border-radius: 10px;
      padding: 8px 14px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    .btn:hover, .tiny-btn:hover {
      background: var(--secondary);
      transform: scale(1.05);
    }
    .btn.secondary {
      background: transparent;
      color: var(--text-color);
      border: 1px solid rgba(0, 0, 0, 0.15);
    }
    .toast {
      position: fixed;
      right: 18px;
      bottom: 18px;
      background: #10b981;
      color: white;
      padding: 12px 18px;
      border-radius: 10px;
      opacity: 0;
      transform: translateY(8px);
      transition: all .32s;
      z-index: 9999;
    }
    .toast.show { opacity: 1; transform: translateY(0); }

    /* üîπ Modales */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, 0.45);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9998;
      padding: 20px;
    }
    .modal {
      background: rgba(255,255,255,0.95);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.25);
      width: 100%;
      max-width: 820px;
      max-height: 90vh;
      overflow-y: auto;
      position: relative;
    }
    .modal h3 { color: var(--text-color); margin-bottom: 10px; }
    .modal .row { display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 12px; }
    .modal label { font-weight: 600; display: block; margin-bottom: 4px; }
    .preview {
      width: 92px;
      height: 92px;
      border-radius: 10px;
      object-fit: cover;
      border: 1px solid rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

  <!-- Fondo animado -->
  <div class="background">
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
    <div class="bubble"></div>
  </div>

  <!-- Header -->
  <header class="admin-header">
    <div class="header-left">
      <img src="logo.png" alt="logo" class="header-logo" />
      <h1>My Store ¬∑ Panel</h1>
    </div>
    <div class="header-right">
      <button class="btn" id="refreshBtn">üîÑ Actualizar</button>
      <button class="btn" id="newBtn">‚ûï Nueva app</button>
      <a href="admin.html" class="btn secondary">‚Ü©Ô∏è Volver al panel principal</a>
    </div>
  </header>

  <!-- Contenido -->
  <main>
    <div class="topbar">
      <h2 style="color:var(--text-color)">üìã Administrar Aplicaciones</h2>

      <div class="controls">
        <input id="searchInput" type="text" placeholder="Buscar por nombre..." />
        <select id="categorySelect">
          <option value="">Todas las categor√≠as</option>
        </select>
        <select id="sortSelect">
          <option value="new">M√°s recientes</option>
          <option value="old">M√°s antiguas</option>
          <option value="name_asc">Nombre A ‚Üí Z</option>
          <option value="name_desc">Nombre Z ‚Üí A</option>
        </select>
        <button id="editCategoriesBtn" class="tiny-btn">‚öôÔ∏è Categor√≠as</button>
        <button id="clearFilter" class="tiny-btn">Limpiar</button>
      </div>
    </div>

    <div id="appsGrid" class="cards-container" aria-live="polite"></div>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Modal Crear/Editar App -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Editar aplicaci√≥n</h3>
      <form id="modalForm">
        <input type="hidden" id="modalId" name="id" />
        <div class="row">
          <div style="flex:1;min-width:220px">
            <label for="modalName">Nombre</label>
            <input id="modalName" name="name" type="text" placeholder="Nombre de la app" required />
          </div>
          <div style="width:140px;display:flex;flex-direction:column;align-items:center;gap:8px">
            <label>Preview</label>
            <img id="modalPreview" class="preview" src="placeholder.png" alt="preview" />
            <div id="paidBadge" style="font-size:.9rem;color:gray;display:none;">üí∞ De pago</div>
          </div>
        </div>

        <div>
          <label for="modalDesc">Descripci√≥n</label>
          <textarea id="modalDesc" name="description" rows="4"></textarea>
        </div>

        <div class="row" style="align-items:center;">
          <div style="min-width:200px">
            <label for="modalCategory">Categor√≠a</label>
            <select id="modalCategory" name="category_id">
              <option value="">-- Seleccionar categor√≠a --</option>
            </select>
          </div>
          <div style="display:flex;align-items:center;gap:8px">
            <label for="modalIsPaid">¬øEs de pago?</label>
            <input type="checkbox" id="modalIsPaid" name="is_paid" />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="modalImage">Imagen (opcional)</label>
            <input id="modalImage" name="image" type="file" accept="image/*" />
          </div>
          <div>
            <label for="modalApk">APK (opcional)</label>
            <input id="modalApk" name="apk" type="file" accept=".apk" />
          </div>
        </div>

        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button type="button" id="modalCancel" class="btn secondary">Cancelar</button>
          <button type="submit" id="modalSave" class="btn">Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Categor√≠as -->
  <div id="catModalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="catModalTitle">
      <h3 id="catModalTitle">Gestionar categor√≠as</h3>

      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
        <input id="newCategoryInput" type="text" placeholder="Nombre categor√≠a (ej. Juegos)" style="flex:1" />
        <button id="addCategoryBtn" class="btn">A√±adir</button>
      </div>

      <div id="categoriesList" style="display:flex;flex-direction:column;gap:8px"></div>

      <div style="display:flex;justify-content:flex-end;margin-top:12px">
        <button id="catModalClose" class="btn secondary">Cerrar</button>
      </div>
    </div>
  </div>

  <footer class="admin-footer">
    ¬© 2025 My Store - Panel de administraci√≥n
  </footer>

  <script>
    /* === Mantiene toda la l√≥gica funcional original === */
    let apps = [], categories = [], editingId = null, lastObjectUrl = null;
    const toastEl = document.getElementById('toast');
    const appsGrid = document.getElementById('appsGrid');

    function showToast(msg, ok = true) {
      toastEl.textContent = msg;
      toastEl.style.background = ok ? '#10b981' : '#ef4444';
      toastEl.classList.add('show');
      setTimeout(() => toastEl.classList.remove('show'), 3000);
    }

    async function safeFetch(path, opts = {}) {
      const res = await fetch(path, { credentials: 'include', ...opts });
      const ctype = res.headers.get('content-type') || '';
      if (ctype.includes('application/json')) {
        const json = await res.json();
        if (!res.ok) throw json;
        return json;
      } else {
        const text = await res.text();
        if (!res.ok) throw { message: text || 'Error' };
        return text;
      }
    }

    async function loadCategories() {
      try {
        categories = await safeFetch('/api/categories');
      } catch (err) {
        categories = [];
      }
      populateCategorySelects();
      renderCategoriesList();
    }

    function populateCategorySelects() {
      const sel = document.getElementById('categorySelect');
      const modalSel = document.getElementById('modalCategory');
      const current = sel.value;
      sel.innerHTML = '<option value="">Todas las categor√≠as</option>';
      modalSel.innerHTML = '<option value="">-- Seleccionar categor√≠a --</option>';
      categories.forEach(c => {
        const o = document.createElement('option');
        o.value = c.id; o.textContent = c.name;
        sel.appendChild(o);
        modalSel.appendChild(o.cloneNode(true));
      });
      if (categories.map(c => String(c.id)).includes(current)) sel.value = current;
    }

    function renderCategoriesList() {
      const wrap = document.getElementById('categoriesList');
      wrap.innerHTML = '';
      categories.forEach(c => {
        const row = document.createElement('div');
        row.style.display = 'flex';
        row.style.justifyContent = 'space-between';
        const left = document.createElement('div'); left.textContent = c.name;
        const btn = document.createElement('button');
        btn.className = 'btn secondary';
        btn.textContent = 'Eliminar';
        btn.onclick = () => removeCategory(c.id);
        row.append(left, btn);
        wrap.appendChild(row);
      });
    }

    async function addCategory(name) {
      try {
        const res = await safeFetch('/api/categories', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name })
        });
        categories.push(res);
        populateCategorySelects();
        renderCategoriesList();
        showToast('Categor√≠a a√±adida');
      } catch (err) {
        showToast(err.message || 'Error al agregar categor√≠a', false);
      }
    }

    async function removeCategory(id) {
      if (!confirm('¬øEliminar categor√≠a?')) return;
      try {
        await safeFetch(`/api/categories/${id}`, { method: 'DELETE' });
        categories = categories.filter(c => c.id !== id);
        populateCategorySelects();
        renderCategoriesList();
        await fetchApps();
        showToast('Categor√≠a eliminada');
      } catch (err) {
        showToast(err.message || 'Error al eliminar', false);
      }
    }

    async function fetchApps() {
      try {
        document.getElementById('refreshBtn').textContent = '‚è≥ Cargando...';
        const data = await safeFetch('/api/apps');
        apps = Array.isArray(data) ? data : data.items || [];
        renderApps();
        populateCategorySelects();
      } catch (err) {
        showToast(err.message || 'Error cargando apps', false);
      } finally {
        document.getElementById('refreshBtn').textContent = 'üîÑ Actualizar';
      }
    }

    function renderApps() {
      const q = document.getElementById('searchInput').value.trim().toLowerCase();
      const cat = document.getElementById('categorySelect').value;
      let list = apps.filter(a => (a.name && a.name.toLowerCase().includes(q)) || (a.description && a.description.toLowerCase().includes(q)));
      if (cat) list = list.filter(a => String(a.category_id) === String(cat));

      const sort = document.getElementById('sortSelect').value;
      if (sort === 'new') list.sort((a,b) => new Date(b.created_at) - new Date(a.created_at));
      if (sort === 'old') list.sort((a,b) => new Date(a.created_at) - new Date(b.created_at));
      if (sort === 'name_asc') list.sort((a,b) => a.name.localeCompare(b.name));
      if (sort === 'name_desc') list.sort((a,b) => b.name.localeCompare(a.name));

      appsGrid.innerHTML = '';
      if (!list.length) {
        appsGrid.innerHTML = '<p style="text-align:center;color:gray">No se encontraron aplicaciones.</p>';
        return;
      }

      list.forEach(app => {
        const card = document.createElement('div');
        card.className = 'card';
        const h3 = document.createElement('h3'); h3.textContent = app.name;
        const p = document.createElement('p'); p.textContent = app.description || '';
        card.append(h3, p);

        const small = document.createElement('small');
        small.textContent = `${app.category_name || 'Sin categor√≠a'} ¬∑ ${new Date(app.created_at).toLocaleString()}`;
        small.style.color = '#666';
        card.appendChild(small);

        const actions = document.createElement('div');
        actions.style.marginTop = '10px';
        actions.style.display = 'flex';
        actions.style.justifyContent = 'center';
        actions.style.gap = '8px';

        const link = document.createElement('a');
        link.href = app.apk || '#';
        link.target = '_blank';
        link.className = 'tiny-btn';
        link.textContent = '‚¨áÔ∏è Descargar APK';
        actions.appendChild(link);

        const editBtn = document.createElement('button');
        editBtn.className = 'tiny-btn';
        editBtn.textContent = '‚úèÔ∏è Editar';
        editBtn.onclick = () => openEdit(app.id);
        actions.appendChild(editBtn);

        const delBtn = document.createElement('button');
        delBtn.className = 'tiny-btn';
        delBtn.textContent = 'üóëÔ∏è Eliminar';
        delBtn.onclick = () => confirmDelete(app.id, delBtn);
        actions.appendChild(delBtn);

        card.append(actions);
        appsGrid.appendChild(card);
      });
    }

    async function confirmDelete(id, btn) {
      if (!confirm('¬øSeguro que deseas eliminar esta app?')) return;
      try {
        btn.disabled = true; btn.textContent = 'Eliminando...';
        await safeFetch(`/apps/${id}`, { method: 'DELETE' });
        apps = apps.filter(a => a.id !== id);
        renderApps();
        showToast('App eliminada');
      } catch (err) {
        showToast(err.message || 'Error', false);
      } finally {
        btn.disabled = false; btn.textContent = 'üóëÔ∏è Eliminar';
      }
    }

    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalForm = document.getElementById('modalForm');
    const modalId = document.getElementById('modalId');
    const modalName = document.getElementById('modalName');
    const modalDesc = document.getElementById('modalDesc');
    const modalImage = document.getElementById('modalImage');
    const modalApk = document.getElementById('modalApk');
    const modalPreview = document.getElementById('modalPreview');
    const modalIsPaid = document.getElementById('modalIsPaid');
    const modalCategory = document.getElementById('modalCategory');
    const modalSave = document.getElementById('modalSave');
    const modalCancel = document.getElementById('modalCancel');

    document.getElementById('newBtn').onclick = openCreate;
    document.getElementById('refreshBtn').onclick = fetchApps;

    function openCreate() {
      editingId = null;
      modalForm.reset();
      modalPreview.src = 'placeholder.png';
      document.getElementById('modalTitle').textContent = 'Crear nueva aplicaci√≥n';
      showModal(modalBackdrop);
    }

    function openEdit(id) {
      const app = apps.find(a => a.id === id);
      if (!app
