<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestionar Aplicaciones - My Store</title>
  <link rel="stylesheet" href="styles-admin.css">
  <link rel="icon" href="logo.png" type="image/png">
  <style>
    /* ==== COMPLEMENTO DE ESTILOS CRUD ==== */
    main.container {
      position: relative;
      z-index: 5;
      padding: 30px 8% 120px 8%;
    }
    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 20px;
    }
    .controls {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }
    .search-box {
      display: flex;
      align-items: center;
      gap: 8px;
      background: rgba(255,255,255,0.35);
      border-radius: 12px;
      padding: 10px 14px;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(114, 9, 183, 0.2);
    }
    .search-box input {
      border: none;
      outline: none;
      background: transparent;
      font-size: 1rem;
      color: var(--text-color);
      width: 220px;
    }
    .select, .tiny-btn, .btn {
      border-radius: 12px;
      border: 1.5px solid rgba(114, 9, 183, 0.2);
      background: rgba(255,255,255,0.5);
      backdrop-filter: blur(10px);
      padding: 8px 12px;
      cursor: pointer;
      transition: all .3s ease;
      color: var(--text-color);
    }
    .btn {
      background: var(--primary);
      color: white;
      border: none;
    }
    .btn:hover { background: var(--secondary); transform: scale(1.05); }
    .btn.secondary { background: rgba(255,255,255,0.5); color: var(--text-color); }
    .apps-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
      gap: 20px;
    }
    .app-card {
      position: relative;
      background: rgba(255,255,255,0.35);
      border: 1.5px solid rgba(114,9,183,0.15);
      border-radius: 16px;
      padding: 16px;
      backdrop-filter: blur(15px);
      box-shadow: 0 3px 18px rgba(0,0,0,0.08);
      transition: all 0.3s ease;
      display: flex;
      flex-direction: column;
      min-height: 180px;
    }
    .app-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 25px rgba(114,9,183,0.25);
    }
    .app-card h3 {
      margin-bottom: 6px;
      color: var(--text-color);
    }
    .app-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #555;
      font-size: 0.9rem;
    }
    .app-desc { font-size: 0.9rem; color: #444; margin: 8px 0; flex: 1; }
    .app-stats {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: #555;
      margin-top: 8px;
    }
    .actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }
    .preview {
      width:64px;height:64px;border-radius:12px;object-fit:cover;border:1px solid rgba(0,0,0,0.06);
    }
    /* Modal transl√∫cido */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 999;
      backdrop-filter: blur(5px);
    }
    .modal {
      background: rgba(255,255,255,0.7);
      backdrop-filter: blur(25px);
      border-radius: 16px;
      border: 1.5px solid rgba(114,9,183,0.2);
      padding: 20px;
      width: 92%;
      max-width: 820px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
    }
    .modal h3 { color: var(--text-color); margin-bottom: 12px; }
    .modal .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 10px;
    }
    .modal input, .modal textarea, .modal select {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid rgba(114,9,183,0.2);
      outline: none;
      background: rgba(255,255,255,0.6);
      color: var(--text-color);
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 15px;
    }
    .small-muted { font-size:0.9rem;color:#6b7280 }
    @media (max-width:520px){
      .search-box input{width:120px}
      .modal{max-width:95%}
    }
  </style>
</head>
<body>
  <div class="background">
    <div class="bubble"></div><div class="bubble"></div><div class="bubble"></div>
    <div class="bubble"></div><div class="bubble"></div>
  </div>

  <header class="admin-header">
    <div class="header-left">
      <img src="logo.png" alt="logo" class="header-logo" />
      <h1>Gestionar Aplicaciones</h1>
    </div>
    <div>
      <a class="logout-btn" id="backToAdmin" href="admin.html">‚Ü©Ô∏è Volver</a>
      <button class="logout-btn" id="logoutBtn">Cerrar sesi√≥n</button>
    </div>
  </header>

  <main class="container">
    <div class="topbar">
      <h2 style="color:var(--text-color)">üìã Administrar Apps</h2>
      <div class="controls">
        <div class="search-box">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" style="opacity:0.9"><path d="M21 21l-4.35-4.35" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/><circle cx="11" cy="11" r="5" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <input type="text" id="searchInput" placeholder="Buscar por nombre o descripci√≥n...">
        </div>
        <select id="categorySelect" class="select"><option value="">Todas las categor√≠as</option></select>
        <select id="sortSelect" class="select">
          <option value="new">M√°s recientes</option>
          <option value="old">M√°s antiguas</option>
          <option value="name_asc">Nombre A ‚Üí Z</option>
          <option value="name_desc">Nombre Z ‚Üí A</option>
        </select>
        <button class="tiny-btn" id="refreshBtn">üîÑ Actualizar</button>
        <button class="btn" id="newBtn">‚ûï Nueva app</button>
      </div>
    </div>
    <div id="appsGrid" class="apps-grid" aria-live="polite"></div>
  </main>

  <footer class="admin-footer">¬© 2025 My Store ‚Äî Panel de administraci√≥n</footer>

  <!-- Modal Crear/Editar -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Editar aplicaci√≥n</h3>
      <form id="modalForm" enctype="multipart/form-data">
        <input type="hidden" id="modalId" name="id" />
        <div class="row">
          <div style="flex:1;min-width:220px">
            <label for="modalName">Nombre</label>
            <input id="modalName" name="name" type="text" placeholder="Nombre de la app" required />
          </div>
          <div style="width:140px;display:flex;flex-direction:column;align-items:center;gap:8px">
            <label>Preview</label>
            <img id="modalPreview" class="preview" src="placeholder.png" alt="preview" />
            <div id="paidBadge" class="small-muted" style="display:none;">üí∞ De pago</div>
          </div>
        </div>

        <div>
          <label for="modalDesc">Descripci√≥n</label>
          <textarea id="modalDesc" name="description" rows="4"></textarea>
        </div>

        <div class="row" style="align-items:center;">
          <div style="min-width:200px">
            <label for="modalCategory">Categor√≠a</label>
            <select id="modalCategory" name="category_id" class="select">
              <option value="">-- Seleccionar categor√≠a --</option>
            </select>
          </div>

          <div style="display:flex;align-items:center;gap:8px">
            <label for="modalIsPaid">¬øEs de pago?</label>
            <input type="checkbox" id="modalIsPaid" name="is_paid" />
          </div>

          <div style="min-width:160px">
            <label for="modalPrice">üíµ Precio (USD)</label>
            <input id="modalPrice" name="price" type="number" step="0.01" min="0" placeholder="0.00" />
          </div>
        </div>

        <div style="display:flex;gap:12px;flex-wrap:wrap;margin-top:8px;align-items:center">
          <div>
            <label for="modalImage">Imagen (opcional)</label>
            <input id="modalImage" name="image" type="file" accept="image/*" />
          </div>

          <div>
            <label for="modalApk">APK (opcional)</label>
            <input id="modalApk" name="apk" type="file" accept=".apk,application/vnd.android.package-archive" />
          </div>
        </div>

        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button type="button" id="modalCancel" class="btn secondary">Cancelar</button>
          <button type="submit" id="modalSave" class="btn">Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // ---------- Session / Proteccion ----------
    async function checkSession() {
      try {
        const res = await fetch('/api/session', { credentials: 'include' });
        const data = await res.json();
        if (!data.loggedIn || data.role !== 'admin') {
          window.location.href = '/login.html';
        }
      } catch (err) {
        window.location.href = '/login.html';
      }
    }
    checkSession();

    // ---------- Elementos ----------
    const appsGrid = document.getElementById('appsGrid');
    const modalBackdrop = document.getElementById('modalBackdrop');
    const modalForm = document.getElementById('modalForm');
    const modalId = document.getElementById('modalId');
    const modalName = document.getElementById('modalName');
    const modalDesc = document.getElementById('modalDesc');
    const modalImage = document.getElementById('modalImage');
    const modalApk = document.getElementById('modalApk');
    const modalPreview = document.getElementById('modalPreview');
    const modalIsPaid = document.getElementById('modalIsPaid');
    const modalCategory = document.getElementById('modalCategory');
    const modalPrice = document.getElementById('modalPrice');
    const modalSave = document.getElementById('modalSave');
    const modalCancel = document.getElementById('modalCancel');
    const searchInput = document.getElementById('searchInput');
    const categorySelect = document.getElementById('categorySelect');
    const sortSelect = document.getElementById('sortSelect');

    let apps = [];
    let categories = [];
    let lastObjectUrl = null;
    let editingId = null;

    function showToast(msg, ok=true){
      // simple toast using alert for now (can be improved)
      console.log(msg);
    }

    async function safeFetch(path, opts = {}) {
      const res = await fetch(path, { credentials: 'include', ...opts });
      const ctype = res.headers.get('content-type') || '';
      if (ctype.includes('application/json')) {
        const json = await res.json();
        if (!res.ok) throw json;
        return json;
      } else {
        const text = await res.text();
        if (!res.ok) throw { message: text || 'Error' };
        return text;
      }
    }

    // ---------- CARGAR CATEGOR√çAS ----------
    async function loadCategories(){
      try {
        categories = await safeFetch('/api/categories');
      } catch (err) {
        categories = [];
      }
      populateCategorySelects();
    }

    function populateCategorySelects(){
      const sel = categorySelect;
      const modalSel = modalCategory;
      const current = sel.value;
      sel.innerHTML = '<option value="">Todas las categor√≠as</option>';
      modalSel.innerHTML = '<option value="">-- Seleccionar categor√≠a --</option>';
      categories.forEach(c => {
        const o = document.createElement('option'); o.value = c.id; o.textContent = c.name;
        sel.appendChild(o);
        const o2 = o.cloneNode(true);
        modalSel.appendChild(o2);
      });
      if([...categories.map(c=>String(c.id))].includes(current)) sel.value = current;
    }

    // ---------- CARGAR APPS ----------
    async function fetchApps(){
      try {
        document.getElementById('refreshBtn').textContent = '‚è≥ Cargando...';
        document.getElementById('refreshBtn').disabled = true;
        const data = await safeFetch('/api/apps');
        apps = Array.isArray(data) ? data : (data.items || []);
        renderApps();
      } catch (err) {
        console.error('Error cargando apps', err);
      } finally {
        document.getElementById('refreshBtn').textContent = 'üîÑ Actualizar';
        document.getElementById('refreshBtn').disabled = false;
      }
    }

    function formatCurrency(v){
      if(v===undefined||v===null) return '0.00';
      return Number(v).toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2});
    }

    function renderApps(){
      const q = searchInput.value.trim().toLowerCase();
      const catFilter = categorySelect.value;
      const sortVal = sortSelect.value;
      let list = apps.filter(a => {
        const name = (a.name||'').toLowerCase();
        const desc = (a.description||'').toLowerCase();
        return name.includes(q) || desc.includes(q);
      });
      if(catFilter) list = list.filter(a => String(a.category_id) === String(catFilter));

      if(sortVal==='new') list.sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
      if(sortVal==='old') list.sort((a,b)=> new Date(a.created_at) - new Date(b.created_at));
      if(sortVal==='name_asc') list.sort((a,b)=> a.name.localeCompare(b.name));
      if(sortVal==='name_desc') list.sort((a,b)=> b.name.localeCompare(a.name));

      appsGrid.innerHTML = '';
      if(list.length===0){
        appsGrid.innerHTML = '<p style="text-align:center;color:var(--text-color)">No se encontraron aplicaciones.</p>'; return;
      }

      list.forEach(app=>{
        const card = document.createElement('div'); card.className='app-card';

        const header = document.createElement('div'); header.style.display='flex'; header.style.justifyContent='space-between'; header.style.alignItems='center';
        const left = document.createElement('div'); left.style.display='flex'; left.style.alignItems='center'; left.style.gap='12px';
        const img = document.createElement('img'); img.src = app.image || 'placeholder.png'; img.className='preview';
        const titleWrap = document.createElement('div');
        const h3 = document.createElement('h3'); h3.textContent = app.name || '';
        const small = document.createElement('div'); small.className='small-muted'; small.textContent = app.category_name || 'Sin categor√≠a';
        titleWrap.appendChild(h3); titleWrap.appendChild(small);
        left.appendChild(img); left.appendChild(titleWrap);

        const right = document.createElement('div'); right.style.textAlign='right';
        const priceSpan = document.createElement('div'); priceSpan.style.fontWeight='700'; priceSpan.style.color='var(--text-color)';
        priceSpan.textContent = app.is_paid ? `üíµ $${formatCurrency(app.price)}` : 'üÜì Gratis';
        right.appendChild(priceSpan);

        header.appendChild(left); header.appendChild(right);
        card.appendChild(header);

        const desc = document.createElement('div'); desc.className='app-desc'; desc.textContent = app.description || '';
        card.appendChild(desc);

        const stats = document.createElement('div'); stats.className='app-stats';
        const downloads = document.createElement('div'); downloads.textContent = `‚¨áÔ∏è ${app.downloads || 0} descargas`;
        const rating = document.createElement('div'); 
        const avg = Number(app.average_rating ?? app.rating ?? 0);
        const rounded = Math.round(avg);
        rating.textContent = `${'‚≠ê'.repeat(rounded)} ${avg.toFixed(1)}`;
        stats.appendChild(downloads); stats.appendChild(rating);
        card.appendChild(stats);

        const actions = document.createElement('div'); actions.className='actions';
        const link = document.createElement('a'); link.href = app.apk || '#'; link.target='_blank'; link.rel='noopener'; link.className='tiny-btn'; link.textContent = '‚¨áÔ∏è Descargar';
        actions.appendChild(link);

        const editBtn = document.createElement('button'); editBtn.className='tiny-btn'; editBtn.textContent='‚úèÔ∏è Editar';
        editBtn.addEventListener('click', ()=> openEdit(app.id));
        actions.appendChild(editBtn);

        const delBtn = document.createElement('button'); delBtn.className='tiny-btn'; delBtn.style.background='#d43f3f'; delBtn.style.color='#fff'; delBtn.textContent='üóëÔ∏è Eliminar';
        delBtn.addEventListener('click', ()=> confirmDelete(app.id, delBtn));
        actions.appendChild(delBtn);

        card.appendChild(actions);
        appsGrid.appendChild(card);
      });
    }

    // ---------- DELETE ----------
    async function confirmDelete(id, btn){
      if(!confirm('¬øSeguro que deseas eliminar esta app?')) return;
      try {
        btn.disabled = true; btn.textContent = 'Eliminando...';
        await safeFetch(`/api/apps/${id}`, { method: 'DELETE' });
        apps = apps.filter(a=>a.id !== id);
        renderApps();
        showToast('Eliminada');
      } catch (err) {
        console.error(err); showToast(err.message || 'Error', false);
      } finally {
        btn.disabled = false; btn.textContent = 'üóëÔ∏è Eliminar';
      }
    }

    // ---------- MODAL ----------
    function showModal(){
      modalBackdrop.style.display = 'flex';
      modalBackdrop.setAttribute('aria-hidden','false');
      setTimeout(()=> modalName.focus(),80);
    }
    function closeModal(){
      modalBackdrop.style.display = 'none';
      modalBackdrop.setAttribute('aria-hidden','true');
      if(lastObjectUrl){ URL.revokeObjectURL(lastObjectUrl); lastObjectUrl = null; }
    }

    document.getElementById('newBtn').addEventListener('click', openCreate);
    document.getElementById('refreshBtn').addEventListener('click', fetchApps);
    modalCancel.addEventListener('click', ()=> closeModal());

    modalImage.addEventListener('change', (e)=>{
      const f = e.target.files[0];
      if(f){ if(lastObjectUrl) URL.revokeObjectURL(lastObjectUrl); lastObjectUrl = URL.createObjectURL(f); modalPreview.src = lastObjectUrl; }
    });

    function openCreate(){
      editingId = null;
      modalId.value = '';
      modalName.value = '';
      modalDesc.value = '';
      modalPreview.src = 'placeholder.png';
      modalImage.value = '';
      modalApk.value = '';
      modalIsPaid.checked = false;
      modalPrice.value = '';
      modalCategory.value = '';
      document.getElementById('modalTitle').textContent = 'Crear nueva aplicaci√≥n';
      modalPrice.parentElement.style.display = 'none';
      showModal();
    }

    function openEdit(id){
      const app = apps.find(a=>a.id===id);
      if(!app){ alert('App no encontrada'); return; }
      editingId = id;
      modalId.value = id;
      modalName.value = app.name || '';
      modalDesc.value = app.description || '';
      modalPreview.src = app.image || 'placeholder.png';
      modalImage.value = '';
      modalApk.value = '';
      modalIsPaid.checked = !!app.is_paid;
      modalPrice.value = app.price || '';
      modalCategory.value = app.category_id || '';
      document.getElementById('modalTitle').textContent = 'Editar aplicaci√≥n';
      modalPrice.parentElement.style.display = app.is_paid ? 'block' : 'none';
      showModal();
    }

    modalIsPaid.addEventListener('change', ()=>{
      modalPrice.parentElement.style.display = modalIsPaid.checked ? 'block' : 'none';
      document.getElementById('paidBadge').style.display = modalIsPaid.checked ? 'block' : 'none';
    });

    modalForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      modalSave.disabled = true; modalSave.textContent = '‚è≥ Guardando...';
      try {
        const fd = new FormData();
        fd.append('name', modalName.value.trim());
        fd.append('description', modalDesc.value.trim());
        fd.append('category_id', modalCategory.value || '');
        fd.append('is_paid', modalIsPaid.checked ? 'true' : 'false');
        fd.append('price', modalIsPaid.checked ? (modalPrice.value || '0') : '0');
        if(modalImage.files[0]) fd.append('image', modalImage.files[0]);
        if(modalApk.files[0]) fd.append('apk', modalApk.files[0]);

        let res;
        if(editingId){
          res = await fetch(`/api/apps/${editingId}`, { method: 'PUT', body: fd, credentials: 'include' });
        } else {
          res = await fetch('/api/apps', { method: 'POST', body: fd, credentials: 'include' });
        }
        const ctype = res.headers.get('content-type') || '';
        const data = ctype.includes('application/json') ? await res.json() : await res.text();
        if(!res.ok) throw new Error(data.message || JSON.stringify(data));
        showToast(editingId ? 'Actualizaci√≥n guardada' : 'App creada');
        closeModal();
        await loadCategories();
        await fetchApps();
      } catch (err) {
        console.error(err);
        alert(err.message || 'Error al guardar');
      } finally {
        modalSave.disabled = false; modalSave.textContent = 'Guardar cambios';
      }
    });

    // ---------- Logout ----------
    document.getElementById('logoutBtn').addEventListener('click', async ()=>{
      if(!confirm('¬øCerrar sesi√≥n?')) return;
      await fetch('/logout', { method: 'POST', credentials: 'include' });
      window.location.href = '/login.html';
    });

    // ---------- Inicializar ----------
    (async function init(){
      await loadCategories();
      await fetchApps();
    })();

    // ---------- filtros ----------
    searchInput.addEventListener('input', renderApps);
    categorySelect.addEventListener('change', renderApps);
    sortSelect.addEventListener('change', renderApps);

  </script>
</body>
</html>
