<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gestionar Aplicaciones</title>
  <link rel="stylesheet" href="styles/styles-admin.css">
  <link rel="icon" href="logo.png" type="image/png" >
</head>
<body>
  <div class="admin-container">
    <header class="admin-header">
      <h1>ğŸ“± GestiÃ³n de Aplicaciones</h1>
      <button id="logoutBtn" class="btn-logout">Cerrar sesiÃ³n</button>
    </header>

    <section class="admin-content">
      <div class="actions">
        <button id="createBtn" class="btn-primary">â• Crear nueva app</button>
      </div>

      <div id="appsList" class="cards-container"></div>
    </section>
  </div>

  <!-- Modal -->
  <div id="appModal" class="modal hidden">
    <div class="modal-content">
      <h2 id="modalTitle">Nueva AplicaciÃ³n</h2>
      <form id="modalForm">
        <input type="hidden" id="modalId" />

        <div class="form-row">
          <div>
            <label>Nombre</label>
            <input id="modalName" required />
          </div>
          <div>
            <label>CategorÃ­a</label>
            <select id="modalCategory" required></select>
          </div>
        </div>

        <div>
          <label>DescripciÃ³n</label>
          <textarea id="modalDescription" required></textarea>
        </div>

        <div class="form-row">
          <div>
            <label><input type="checkbox" id="modalIsPaid" /> Â¿Es de pago?</label>
          </div>
          <div style="min-width:160px">
            <label for="modalPrice">ğŸ’µ Precio (USD)</label>
            <input id="modalPrice" name="price" type="number" step="0.01" min="0" placeholder="0.00" />
          </div>
        </div>

        <div class="form-actions">
          <button type="submit" class="btn-primary">Guardar</button>
          <button type="button" id="cancelBtn" class="btn-secondary">Cancelar</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const appsList = document.getElementById('appsList');
    const createBtn = document.getElementById('createBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const modal = document.getElementById('appModal');
    const modalForm = document.getElementById('modalForm');
    const modalTitle = document.getElementById('modalTitle');
    const modalId = document.getElementById('modalId');
    const modalName = document.getElementById('modalName');
    const modalDescription = document.getElementById('modalDescription');
    const modalCategory = document.getElementById('modalCategory');
    const modalIsPaid = document.getElementById('modalIsPaid');
    const modalPrice = document.getElementById('modalPrice');
    const cancelBtn = document.getElementById('cancelBtn');

    // Oculta o muestra el campo de precio
    modalPrice.parentElement.style.display = 'none';
    modalIsPaid.addEventListener('change', () => {
      modalPrice.parentElement.style.display = modalIsPaid.checked ? 'block' : 'none';
    });

    // Abrir modal para crear
    createBtn.addEventListener('click', () => openCreate());
    cancelBtn.addEventListener('click', () => closeModal());
    logoutBtn.addEventListener('click', async () => {
      await fetch('/api/logout', { method: 'POST' });
      location.href = '/';
    });

    function openCreate() {
      modalId.value = '';
      modalTitle.textContent = 'Nueva AplicaciÃ³n';
      modalName.value = '';
      modalDescription.value = '';
      modalCategory.value = '';
      modalIsPaid.checked = false;
      modalPrice.value = '';
      modalPrice.parentElement.style.display = 'none';
      modal.classList.remove('hidden');
    }

    function openEdit(app) {
      modalId.value = app.id;
      modalTitle.textContent = 'Editar AplicaciÃ³n';
      modalName.value = app.name;
      modalDescription.value = app.description;
      modalCategory.value = app.category_id || '';
      modalIsPaid.checked = app.is_paid;
      modalPrice.value = app.price || '';
      modalPrice.parentElement.style.display = app.is_paid ? 'block' : 'none';
      modal.classList.remove('hidden');
    }

    function closeModal() {
      modal.classList.add('hidden');
    }

    modalForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const id = modalId.value;
      const fd = new FormData();
      fd.append('name', modalName.value);
      fd.append('description', modalDescription.value);
      fd.append('category_id', modalCategory.value);
      fd.append('is_paid', modalIsPaid.checked);
      fd.append('price', modalIsPaid.checked ? modalPrice.value || '0' : '0');

      const method = id ? 'PUT' : 'POST';
      const url = id ? `/api/apps/${id}` : '/api/apps';

      await fetch(url, { method, body: fd });
      closeModal();
      loadApps();
    });

    async function loadCategories() {
      const res = await fetch('/api/categories');
      const categories = await res.json();
      modalCategory.innerHTML = categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    }

    async function loadApps() {
      const res = await fetch('/api/apps');
      const apps = await res.json();
      renderApps(apps);
    }

    function renderApps(apps) {
      appsList.innerHTML = '';
      apps.forEach(app => {
        const card = document.createElement('div');
        card.className = 'card';

        const title = document.createElement('h3');
        title.textContent = app.name;

        const desc = document.createElement('p');
        desc.textContent = app.description;

        const info = document.createElement('div');
        info.className = 'app-info';
        info.innerHTML = `
          <span>${app.category_name || 'Sin categorÃ­a'}</span>
          <span>${app.is_paid ? `ğŸ’µ $${app.price}` : 'ğŸ†“ Gratis'}</span>
        `;

        // Info adicional: descargas y estrellas
        const stats = document.createElement('div');
        stats.className = 'app-stats';
        const downloads = `â¬‡ï¸ ${app.downloads || 0}`;
        const stars = 'â­'.repeat(Math.round(app.rating || 0)) + 'â˜†'.repeat(5 - Math.round(app.rating || 0));
        stats.innerHTML = `<span>${downloads}</span><span>${stars}</span>`;

        const actions = document.createElement('div');
        actions.className = 'actions';
        const editBtn = document.createElement('button');
        editBtn.textContent = 'âœï¸ Editar';
        editBtn.className = 'btn-edit';
        editBtn.onclick = () => openEdit(app);

        const delBtn = document.createElement('button');
        delBtn.textContent = 'ğŸ—‘ï¸ Eliminar';
        delBtn.className = 'btn-delete';
        delBtn.onclick = async () => {
          if (confirm(`Â¿Eliminar "${app.name}"?`)) {
            await fetch(`/api/apps/${app.id}`, { method: 'DELETE' });
            loadApps();
          }
        };

        actions.append(editBtn, delBtn);
        card.append(title, desc, info, stats, actions);
        appsList.appendChild(card);
      });
    }

    loadCategories();
    loadApps();
  </script>
</body>
</html>
