<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gestionar Aplicaciones | My Store</title>
  <link rel="icon" href="img/logo.png" type="img/png"/>
  <link rel="stylesheet" href="styles/styles-admin.css" />
  <style>
    :root { --muted: #6b7280; --card-gap: 18px; --price-color: #b45309; }
    main.container { max-width:1200px; margin:20px auto; padding:0 18px 80px; }
    .topbar { display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom:16px; padding: 10px 0; }
    .title { margin:0; color:var(--text-color); font-size:1.35rem; }
    .controls { display:flex; gap:12px; align-items:center; flex-wrap:wrap; }
    .controls input[type="text"], .controls select { padding:10px 12px; border-radius:10px; border:1px solid rgba(0,0,0,0.08); background: rgba(255,255,255,0.9); font-size:0.95rem; }
    .controls .tiny { padding:8px 10px; border-radius:10px; border:none; background:var(--primary); color:var(--text-light); cursor:pointer; }
    .apps-grid { display:grid; gap:var(--card-gap); grid-template-columns: repeat(2, 1fr); align-items:start; }
    @media (max-width:920px) { .apps-grid { grid-template-columns: repeat(1, 1fr); } }
    .card { position:relative; background: rgba(255,255,255,0.35); backdrop-filter: blur(12px); border-radius: 16px; box-shadow: 0 6px 20px rgba(2,6,23,0.06); padding: 16px; display:flex; gap:12px; align-items:flex-start; transition: transform .28s ease, box-shadow .28s ease; border: 1.5px solid rgba(114,9,183,0.06); }
    .card:hover { transform: translateY(-6px); box-shadow: 0 16px 40px rgba(114,9,183,0.12); border-color:var(--primary); }
    .card .thumb { width:92px; height:92px; border-radius:12px; object-fit:cover; flex-shrink:0; border:1px solid rgba(0,0,0,0.06); }
    .card .info { flex:1; display:flex; flex-direction:column; gap:6px; }
    .card h3 { margin:0; color:var(--text-color); font-size:1.05rem; }
    .card p.desc { margin:0; color:#374151; font-size:0.95rem; line-height:1.35; }
    .meta-small { font-size:.85rem; color:var(--muted); }
    .price-badge { font-weight:700; color:var(--price-color); }
    .card .actions { display:flex; gap:8px; margin-top:8px; align-items:center; flex-wrap:wrap; }
    .btn { padding:8px 12px; border-radius:10px; border:none; cursor:pointer; background:var(--primary); color:var(--text-light); }
    .btn.secondary { background:transparent; border:1px solid rgba(0,0,0,0.08); color:var(--text-color); }
    .btn.danger { background:var(--danger); color:white; }
    .btn[disabled] { opacity:.6; cursor:not-allowed; }
    .toast { position:fixed; right:18px; bottom:18px; background:#10b981; color:white; padding:12px 18px; border-radius:10px; opacity:0; transform:translateY(8px); transition:all .32s; z-index:9999; }
    .toast.show { opacity:1; transform:translateY(0); }
    .modal-backdrop { position:fixed; inset:0; background:rgba(2,6,23,0.45); display:none; align-items:center; justify-content:center; z-index:9998; padding:20px; }
    .modal-backdrop.show { display:flex; }
    .modal { width:100%; max-width:920px; background:rgba(255,255,255,0.95); border-radius:12px; padding:18px; box-shadow:0 20px 60px rgba(2,6,23,0.35); max-height:92vh; overflow:auto; }
    .modal h3 { margin:0 0 10px 0; color:var(--text-color); }
    .modal .row { display:flex; gap:12px; margin-bottom:12px; align-items:center; flex-wrap:wrap; }
    .preview-thumb { width:72px; height:72px; border-radius:8px; object-fit:cover; border:1px solid rgba(0,0,0,0.06); }
    .image-preview-list { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
    .stars { position:relative; display:inline-block; font-size:18px; color:rgba(0,0,0,0.15); }
    .stars .filled { position:absolute; top:0; left:0; height:100%; overflow:hidden; color:#ffbf00; white-space:nowrap; pointer-events:none; }
    .gallery { display:flex; gap:8px; flex-wrap:wrap; }
    .gallery img { width:120px; height:120px; object-fit:cover; border-radius:10px; }
    @media (max-width:520px) { .controls { width:100%; justify-content:flex-start; gap:8px; } }

    /* small helpers for category modal */
    .cat-row { display:flex; justify-content:space-between; align-items:center; gap:12px; padding:8px 0; border-bottom:1px dashed rgba(0,0,0,0.04); }
    .muted-small { font-size:.85rem; color:var(--muted); }
  </style>
</head>
<body>

  <div class="background" aria-hidden="true"><div class="bubble"></div><div class="bubble"></div><div class="bubble"></div></div>

  <header class="admin-header" role="banner">
    <div class="header-left">
      <img src="logo.png" alt="logo" class="header-logo" />
      <div>
        <h1>My Store ¬∑ Panel</h1>
        <small class="small-muted">Panel ¬∑ administraci√≥n de apps</small>
      </div>
    </div>
    <div class="header-actions">
      <button class="btn" id="refreshBtn" aria-label="Actualizar">üîÑ Actualizar</button>
      <button class="btn" id="newBtn" aria-label="Nueva aplicaci√≥n" style="background:var(--accent)">‚ûï Nueva app</button>
      <a class="btn secondary" href="admin.html">‚Ü©Ô∏è Volver al panel principal</a>
    </div>
  </header>

  <main class="container">
    <div class="topbar">
      <h2 class="title">üìã Administrar Aplicaciones</h2>

      <div class="controls" role="search" aria-label="Controles de filtro">
        <input id="searchInput" type="text" placeholder="Buscar por nombre..." aria-label="Buscar por nombre" />
        <select id="categorySelect" aria-label="Filtrar por categor√≠a"><option value="">Todas las categor√≠as</option></select>
        <select id="sortSelect" aria-label="Ordenar">
          <option value="new">M√°s recientes</option>
          <option value="old">M√°s antiguas</option>
          <option value="name_asc">Nombre A ‚Üí Z</option>
          <option value="name_desc">Nombre Z ‚Üí A</option>
        </select>
        <button id="editCategoriesBtn" class="tiny" aria-haspopup="dialog">‚öôÔ∏è Administrar categor√≠as</button>
        <button id="clearFilter" class="tiny secondary">Limpiar</button>
      </div>
    </div>

    <div id="appsGrid" class="apps-grid" aria-live="polite"></div>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <!-- Modal Crear/Editar App -->
  <div id="modalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Editar aplicaci√≥n</h3>
      <form id="modalForm">
        <input type="hidden" id="modalId" name="id" />
        <div class="row">
          <div style="flex:1;min-width:240px">
            <label for="modalName">Nombre</label>
            <input id="modalName" name="name" type="text" placeholder="Nombre de la app" required />
          </div>
          <div style="width:140px;display:flex;flex-direction:column;align-items:center;gap:8px">
            <label>Preview</label>
            <img id="modalPreview" class="preview-thumb" src="placeholder.png" alt="preview" />
            <div id="paidBadge" class="small-muted" style="display:none;">üí∞ De pago</div>
          </div>
        </div>

        <div><label for="modalVersion">Versi√≥n</label><input id="modalVersion" name="version" type="text" placeholder="Ej. 1.2.3" /></div>
        <div><label for="modalDesc">Descripci√≥n</label><textarea id="modalDesc" name="description" rows="4"></textarea></div>

        <div class="row" style="align-items:center;">
          <div style="min-width:200px">
            <label for="modalCategory">Categor√≠a</label>
            <select id="modalCategory" name="category">
              <option value="">-- Seleccionar categor√≠a --</option>
            </select>
          </div>

          <div style="display:flex;align-items:center;gap:8px">
            <label for="modalIsPaid">¬øEs de pago?</label>
            <div id="priceField" style="display:none;">
              <label for="modalPrice">Precio (USD)</label>
              <input id="modalPrice" name="price" type="number" step="0.01" min="0" placeholder="Ej. 1.99" />
            </div>
            <input type="checkbox" id="modalIsPaid" name="is_paid" />
          </div>

          <div style="margin-left:auto;display:flex;flex-direction:column;align-items:flex-end">
            <label>Calificaci√≥n</label>
            <div style="display:flex;align-items:center;gap:8px">
              <div class="stars" aria-hidden="true"><div class="base">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div><div class="filled" style="width:0%">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div></div>
              <div id="ratingText" style="font-size:.95rem;color:var(--muted)">0.0 / 5</div>
            </div>
            <div style="font-size:.8rem;color:var(--muted)">Promedio (solo lectura)</div>
          </div>
        </div>

        <hr style="margin:12px 0;border:none;border-top:1px solid rgba(0,0,0,0.06)">

        <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-start">
          <div style="flex:1;min-width:220px">
            <label for="modalImage">Imagen principal (opcional)</label>
            <input id="modalImage" name="image" type="file" accept="image/*" />
          </div>

          <div style="flex:1;min-width:260px">
            <label for="modalImages">Im√°genes de muestra (3 a 5) <small style="color:var(--muted)">(se reemplazar√°n si subes nuevas)</small></label>
            <input id="modalImages" name="images" type="file" accept="image/*" multiple />
            <div id="imagesPreview" class="image-preview-list"></div>
          </div>

          <div style="min-width:160px">
            <label for="modalApk">APK (opcional)</label>
            <input id="modalApk" name="apk" type="file" accept=".apk,application/vnd.android.package-archive" />
            <div id="apkName" style="font-size:.85rem;color:var(--muted);margin-top:6px"></div>
          </div>
        </div>

        <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px">
          <button type="button" id="modalCancel" class="btn secondary">Cancelar</button>
          <button type="submit" id="modalSave" class="btn">Guardar cambios</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal Categor√≠as -->
  <div id="catModalBackdrop" class="modal-backdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="catModalTitle">
      <h3 id="catModalTitle">Gestionar categor√≠as</h3>

      <div style="display:flex;gap:12px;align-items:center;margin-bottom:12px">
        <input id="newCategoryInput" type="text" placeholder="Nombre categor√≠a (ej. Juegos)" style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd" />
        <input id="newCategoryDesc" type="text" placeholder="Descripci√≥n (opcional)" style="flex:1;padding:10px;border-radius:8px;border:1px solid #ddd" />
        <button id="addCategoryBtn" class="btn">A√±adir</button>
      </div>

      <div id="categoriesList" style="display:flex;flex-direction:column;gap:8px"></div>

      <!-- Edit category inline modal area -->
      <div id="editCatArea" style="display:none;margin-top:12px;padding-top:12px;border-top:1px solid rgba(0,0,0,0.06)">
        <h4>Editar categor√≠a</h4>
        <div style="display:flex;gap:8px;align-items:center;">
          <input id="editCatName" type="text" placeholder="Nombre" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd" />
          <input id="editCatDesc" type="text" placeholder="Descripci√≥n" style="flex:1;padding:8px;border-radius:6px;border:1px solid #ddd" />
          <button id="saveEditCatBtn" class="btn">Guardar</button>
          <button id="cancelEditCatBtn" class="btn secondary">Cancelar</button>
        </div>
      </div>

      <div style="display:flex;justify-content:flex-end;margin-top:12px">
        <button id="catModalClose" class="btn secondary">Cerrar</button>
      </div>
    </div>
  </div>

  <!-- Modal Detalle (galer√≠a) -->
  <div id="detailBackdrop" class="modal-backdrop" style="display:none;" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="detailTitle">
      <h3 id="detailTitle">Detalles de la app</h3>
      <div id="detailContent"></div>
      <div style="display:flex;justify-content:flex-end;margin-top:12px">
        <button id="detailClose" class="btn secondary">Cerrar</button>
      </div>
    </div>
  </div>

<script>
  // ---------- Estado ----------
  let apps = [];
  let categories = [];
  let editingId = null;
  let selectedFiles = []; // im√°genes nuevas seleccionadas en modal
  let lastObjectUrl = null;

  // Category edit state
  let editingCategoryId = null;

  // ---------- Elementos ----------
  const toastEl = document.getElementById('toast');
  const appsGrid = document.getElementById('appsGrid');

  function showToast(msg, ok=true){
    toastEl.textContent = msg;
    toastEl.style.background = ok ? '#10b981' : '#ef4444';
    toastEl.classList.add('show');
    setTimeout(()=> toastEl.classList.remove('show'), 3000);
  }

  // safeFetch (ya lo quer√≠as as√≠)
  async function safeFetch(path, opts = {}){
    const res = await fetch(path, { credentials: 'include', ...opts });
    const ctype = res.headers.get('content-type') || '';
    if(ctype.includes('application/json')){
      const json = await res.json();
      if(!res.ok) throw json;
      return json;
    } else {
      const text = await res.text();
      if(!res.ok) throw { message: text || 'Error' };
      return text;
    }
  }

  // ---------- CATEGOR√çAS ----------
  async function loadCategories(){
    try {
      categories = await safeFetch('/api/categories');
    } catch (err) {
      console.error('Error cargando categorias', err);
      categories = [];
    }
    populateCategorySelects();
    renderCategoriesList();
  }

  function populateCategorySelects(){
    const sel = document.getElementById('categorySelect');
    const modalSel = document.getElementById('modalCategory');
    const current = sel ? sel.value : '';
    if(sel) sel.innerHTML = '<option value="">Todas las categor√≠as</option>';
    if(modalSel) modalSel.innerHTML = '<option value="">-- Seleccionar categor√≠a --</option>';
    categories.forEach(c => {
      const val = c.id ?? c.name;
      if(sel){
        const o = document.createElement('option'); o.value = val; o.textContent = c.name || val;
        sel.appendChild(o);
      }
      if(modalSel){
        const o2 = document.createElement('option'); o2.value = val; o2.textContent = c.name || val;
        modalSel.appendChild(o2);
      }
    });
    if(sel && [...categories.map(c=>String(c.id))].includes(current)) sel.value = current;
  }

  function renderCategoriesList(){
    const wrap = document.getElementById('categoriesList');
    wrap.innerHTML = '';
    categories.forEach(c=>{
      const row = document.createElement('div');
      row.className = 'cat-row';
      const left = document.createElement('div');
      left.innerHTML = `<strong>${c.name}</strong><div class="muted-small">${c.description || ''}</div>`;
      const right = document.createElement('div');
      const editBtn = document.createElement('button'); editBtn.className='btn secondary'; editBtn.textContent='Editar';
      editBtn.addEventListener('click', ()=> openEditCategory(c));
      const delBtn = document.createElement('button'); delBtn.className='btn danger'; delBtn.textContent='Eliminar';
      delBtn.addEventListener('click', ()=> removeCategory(c.id));
      right.appendChild(editBtn); right.appendChild(delBtn);
      row.appendChild(left); row.appendChild(right);
      wrap.appendChild(row);
    });
  }

  async function addCategory(name, description=''){
    try {
      const res = await safeFetch('/api/categories', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, description })
      });
      // If backend returns created object, push it; else reload
      if (res && res.id) categories.push(res);
      else await loadCategories();
      populateCategorySelects();
      renderCategoriesList();
      showToast('Categor√≠a a√±adida');
    } catch (err) {
      console.error(err);
      showToast(err.message || 'Error al agregar categor√≠a', false);
    }
  }

  async function removeCategory(id){
    if(!confirm('Eliminar categor√≠a? Las apps perder√°n su categor√≠a.')) return;
    try {
      await safeFetch(`/api/categories/${id}`, { method: 'DELETE' });
      categories = categories.filter(c=>c.id !== id);
      populateCategorySelects();
      renderCategoriesList();
      showToast('Categor√≠a eliminada');
      await fetchApps();
    } catch (err) {
      console.error(err);
      showToast(err.message || 'Error al eliminar', false);
    }
  }

  function openEditCategory(cat){
    editingCategoryId = cat.id;
    document.getElementById('editCatName').value = cat.name || '';
    document.getElementById('editCatDesc').value = cat.description || '';
    document.getElementById('editCatArea').style && (document.getElementById('editCatArea').style.display = 'block'); // safety
    document.getElementById('editCatArea') && (document.getElementById('editCatArea').style.display = 'block');
    document.getElementById('editCatArea') || (document.getElementById('editCatArea')); // noop
    document.getElementById('editCatArea'); // noop for safety in some DOMs
    document.getElementById('editCatArea'); // noop
    // show internal edit area
    document.getElementById('editCatArea')?.scrollIntoView({ behavior: 'smooth' });
    document.getElementById('editCatArea'); // noop
    document.getElementById('editCatArea'); // noop
    // show edit area in UI
    document.getElementById('editCatArea') && (document.getElementById('editCatArea').style.display = 'block');
    document.getElementById('editCatName').focus();
    // also set hidden fields
    document.getElementById('editCatName').dataset.catId = cat.id;
    document.getElementById('editCatDesc').dataset.catId = cat.id;
  }

  async function saveEditedCategory(){
    if(!editingCategoryId) return;
    const name = document.getElementById('editCatName').value.trim();
    const description = document.getElementById('editCatDesc').value.trim();
    if(!name) return showToast('El nombre es obligatorio', false);
    try {
      const res = await safeFetch(`/api/categories/${editingCategoryId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ name, description })
      });
      // update local array
      const idx = categories.findIndex(c=>c.id === editingCategoryId);
      if(idx !== -1) categories[idx] = { ...categories[idx], name, description };
      renderCategoriesList();
      populateCategorySelects();
      editingCategoryId = null;
      document.getElementById('editCatName').value = '';
      document.getElementById('editCatDesc').value = '';
      document.getElementById('editCatArea') && (document.getElementById('editCatArea').style.display = 'none');
      showToast('Categor√≠a actualizada');
    } catch (err) {
      console.error(err);
      showToast(err.message || 'Error al actualizar', false);
    }
  }

  // --- wire category modal controls
  document.getElementById('addCategoryBtn').addEventListener('click', async ()=> {
    const name = document.getElementById('newCategoryInput').value.trim();
    const desc = document.getElementById('newCategoryDesc').value.trim();
    if(!name) return showToast('El nombre es obligatorio', false);
    await addCategory(name, desc);
    document.getElementById('newCategoryInput').value = '';
    document.getElementById('newCategoryDesc').value = '';
  });
  document.getElementById('saveEditCatBtn').addEventListener('click', saveEditedCategory);
  document.getElementById('cancelEditCatBtn').addEventListener('click', ()=> {
    editingCategoryId = null;
    document.getElementById('editCatName').value = '';
    document.getElementById('editCatDesc').value = '';
    document.getElementById('editCatArea') && (document.getElementById('editCatArea').style.display = 'none');
  });

  // open/close cat modal
  const catModal = document.getElementById('catModalBackdrop');
  document.getElementById('editCategoriesBtn').addEventListener('click', ()=> { catModal.style.display = 'flex'; catModal.setAttribute('aria-hidden','false'); document.getElementById('newCategoryInput').focus(); });
  document.getElementById('catModalClose').addEventListener('click', ()=> { catModal.style.display = 'none'; catModal.setAttribute('aria-hidden','true'); });

  // ---------- CARGAR APPS ----------
  async function fetchApps(){
    try {
      document.getElementById('refreshBtn').textContent = '‚è≥ Cargando...';
      document.getElementById('refreshBtn').disabled = true;
      const data = await safeFetch('/api/apps');
      apps = Array.isArray(data) ? data : (data.items || []);
      renderApps();
      populateCategorySelects();
    } catch (err) {
      console.error(err);
      showToast(err.message || 'Error cargando apps', false);
    } finally {
      document.getElementById('refreshBtn').textContent = 'üîÑ Actualizar';
      document.getElementById('refreshBtn').disabled = false;
    }
  }

  function formatPrice(val){
    const num = Number(val);
    if (Number.isFinite(num)) return num.toFixed(2);
    return '0.00';
  }

  function renderApps(){
    const q = document.getElementById('searchInput').value.trim().toLowerCase();
    const catFilter = document.getElementById('categorySelect').value;
    let list = apps.filter(a => (a.name && a.name.toLowerCase().includes(q)) || (a.description && a.description.toLowerCase().includes(q)));
    if(catFilter) list = list.filter(a => String(a.category) === String(catFilter) || String(a.category_id) === String(catFilter));

    const sortVal = document.getElementById('sortSelect').value;
    if(sortVal==='new') list.sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
    if(sortVal==='old') list.sort((a,b)=> new Date(a.created_at) - new Date(b.created_at));
    if(sortVal==='name_asc') list.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    if(sortVal==='name_desc') list.sort((a,b)=> (b.name||'').localeCompare(a.name||''));

    appsGrid.innerHTML = '';
    if(list.length===0){
      appsGrid.innerHTML = '<p style="text-align:center;color:var(--muted)">No se encontraron aplicaciones.</p>'; return;
    }

    list.forEach(app=>{
      const card = document.createElement('div'); card.className='card';
      const img = document.createElement('img'); img.className='thumb';
      let firstImg = null;
      try { firstImg = (app.image || (app.images && (Array.isArray(app.images) ? app.images[0] : (JSON.parse(app.images||'[]')||[])[0])) ) || 'placeholder.png'; } catch(e){ firstImg = app.image || 'placeholder.png'; }
      img.src = firstImg;
      img.alt = app.name || 'app';

      const info = document.createElement('div'); info.className='info';
      const h3 = document.createElement('h3'); h3.textContent = app.name;
      const small = document.createElement('div'); small.className='meta-small'; small.textContent = `${app.category || 'Sin categor√≠a'} ¬∑ ${app.created_at ? new Date(app.created_at).toLocaleString() : ''}`;
      const desc = document.createElement('p'); desc.className='desc'; desc.textContent = app.description || '';

      const priceTag = document.createElement('p');
      priceTag.className = 'meta-small price-badge';
      priceTag.textContent = app.is_paid ? `üí∞ $${formatPrice(app.price)}` : 'Gratis';

      // rating
      const ratingWrap = document.createElement('div'); ratingWrap.style.display='flex'; ratingWrap.style.gap='8px'; ratingWrap.style.alignItems='center';
      const stars = document.createElement('div'); stars.className='stars'; stars.setAttribute('aria-hidden','true');
      stars.innerHTML = '<div class="base">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div><div class="filled" style="width:0%">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</div>';
      const avg = parseFloat(app.average_rating || 0);
      const pct = Math.max(0, Math.min(100, (avg/5)*100));
      stars.querySelector('.filled').style.width = pct + '%';
      const ratingText = document.createElement('div'); ratingText.textContent = (isNaN(avg) ? '0.0' : Number(avg).toFixed(1)) + ' / 5';
      ratingText.className = 'meta-small';
      ratingWrap.appendChild(stars); ratingWrap.appendChild(ratingText);

      // actions
      const actions = document.createElement('div'); actions.className='actions';
      const dl = document.createElement('a'); dl.className='btn secondary';
      if (app.apk) { dl.href = app.apk; dl.target='_blank'; dl.rel='noopener'; dl.textContent = '‚¨áÔ∏è APK'; }
      else { dl.href = '#'; dl.textContent = '‚Äî APK ‚Äî'; dl.classList.add('secondary'); dl.style.opacity = .6; dl.style.pointerEvents = 'none'; }

      const view = document.createElement('button'); view.className='btn'; view.textContent='üîç Ver detalles'; view.addEventListener('click', ()=> openDetail(app.id));
      const editBtn = document.createElement('button'); editBtn.className='btn'; editBtn.textContent='‚úèÔ∏è Editar'; editBtn.addEventListener('click', ()=> openEdit(app.id));
      const delBtn = document.createElement('button'); delBtn.className='btn danger'; delBtn.textContent='üóëÔ∏è Eliminar'; delBtn.addEventListener('click', ()=> confirmDelete(app.id, delBtn));
      actions.appendChild(dl); actions.appendChild(view); actions.appendChild(editBtn); actions.appendChild(delBtn);

      info.appendChild(h3); info.appendChild(small); info.appendChild(desc); info.appendChild(priceTag); info.appendChild(ratingWrap); info.appendChild(actions);
      card.appendChild(img); card.appendChild(info);
      appsGrid.appendChild(card);
    });
  }

  // ---------- DELETE APP ----------
  async function confirmDelete(id, btn){
    if(!confirm('¬øSeguro? Esta acci√≥n no se puede deshacer.')) return;
    try {
      btn.disabled = true; btn.textContent = 'Eliminando...';
      await safeFetch(`/api/apps/${id}`, { method: 'DELETE' });
      apps = apps.filter(a=>a.id !== id);
      renderApps();
      showToast('Eliminado');
    } catch (err) {
      console.error(err); showToast(err.message || 'Error', false);
    } finally { btn.disabled = false; btn.textContent = 'üóëÔ∏è Eliminar'; }
  }

  // ---------- MODAL APP ----------
  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalForm = document.getElementById('modalForm');
  const modalId = document.getElementById('modalId');
  const modalName = document.getElementById('modalName');
  const modalVersion = document.getElementById('modalVersion');
  const modalDesc = document.getElementById('modalDesc');
  const modalImage = document.getElementById('modalImage');
  const modalImages = document.getElementById('modalImages');
  const imagesPreview = document.getElementById('imagesPreview');
  const modalApk = document.getElementById('modalApk');
  const apkName = document.getElementById('apkName');
  const modalPreview = document.getElementById('modalPreview');
  const modalIsPaid = document.getElementById('modalIsPaid');
  const modalCategory = document.getElementById('modalCategory');
  const modalSave = document.getElementById('modalSave');

  modalCancel.addEventListener('click', () => closeModal(modalBackdrop));
  document.getElementById('newBtn').addEventListener('click', openCreate);
  document.getElementById('refreshBtn').addEventListener('click', fetchApps);

  function resetImageInputs(){
    modalImage.value = '';
    modalImages.value = '';
    imagesPreview.innerHTML = '';
    apkName.textContent = '';
    selectedFiles = [];
    if(lastObjectUrl){ URL.revokeObjectURL(lastObjectUrl); lastObjectUrl = null; }
  }

  function showModal(el){
    el.classList.add('show');
    el.style.display = 'flex';
    el.setAttribute('aria-hidden','false');
    setTimeout(()=> modalName.focus(), 80);
  }
  function closeModal(el){
    el.classList.remove('show');
    el.style.display = 'none';
    el.setAttribute('aria-hidden','true');
    resetImageInputs();
    editingId = null;
  }

  function openCreate(){
    editingId = null;
    modalForm.reset();
    modalPreview.src = 'placeholder.png';
    document.getElementById('modalTitle').textContent = 'Crear nueva aplicaci√≥n';
    imagesPreview.innerHTML = '';
    priceField.style.display = 'none';
    document.querySelector('.stars .filled').style.width = '0%';
    document.getElementById('ratingText').textContent = '0.0 / 5';
    showModal(modalBackdrop);
  }

  function openEdit(id){
    const app = apps.find(a=>a.id===id);
    if(!app){ showToast('App no encontrada', false); return; }
    editingId = id;
    modalId.value = id;
    modalName.value = app.name || '';
    modalVersion.value = app.version || '';
    modalDesc.value = app.description || '';
    try { modalPreview.src = app.image || (app.images && (Array.isArray(app.images) ? app.images[0] : (JSON.parse(app.images||'[]')||[])[0])) || 'placeholder.png'; } catch(e){ modalPreview.src = app.image || 'placeholder.png'; }
    modalIsPaid.checked = !!app.is_paid;
    priceField.style.display = modalIsPaid.checked ? 'block' : 'none';
    modalPrice.value = app.price ?? '';

    modalCategory.value = app.category || app.category_id || '';
    modalImages.value = '';
    imagesPreview.innerHTML = '';

    // show existing images in preview area (these are preserved unless user uploads new ones)
    const imgs = app.images && Array.isArray(app.images) ? app.images : (app.images ? JSON.parse(app.images) : []);
    imgs.forEach((u, idx) => {
      const wrap = createImagePreviewElement(null, u, true);
      if(wrap) {
        wrap.dataset.remote = 'true';
        wrap.dataset.src = u;
        imagesPreview.appendChild(wrap);
      }
    });

    // rating display
    const avg = parseFloat(app.average_rating || 0);
    const pct = Math.max(0, Math.min(100, (avg/5)*100));
    document.querySelector('.stars .filled').style.width = pct + '%';
    document.getElementById('ratingText').textContent = (isNaN(avg) ? '0.0' : Number(avg).toFixed(1)) + ' / 5';

    document.getElementById('modalTitle').textContent = 'Editar aplicaci√≥n';
    showModal(modalBackdrop);
  }

  // ---------- Image previews handling ----------
  function createImagePreviewElement(file, url = null, removable = true){
    const container = document.createElement('div'); container.style.position='relative'; container.style.display='inline-block';
    const img = document.createElement('img'); img.className='preview-thumb';
    img.src = url || (file ? URL.createObjectURL(file) : 'placeholder.png');
    img.alt = 'preview';
    container.appendChild(img);
    if(removable){
      const btn = document.createElement('button');
      btn.type='button';
      btn.textContent='‚úñ';
      btn.title='Eliminar';
      btn.style.position='absolute';
      btn.style.top='-6px';
      btn.style.right='-6px';
      btn.style.border='none';
      btn.style.background='rgba(0,0,0,0.6)';
      btn.style.color='white';
      btn.style.borderRadius='50%';
      btn.style.width='22px';
      btn.style.height='22px';
      btn.style.cursor='pointer';
      btn.addEventListener('click', ()=>{
        if(!file && url){
          container.remove();
        } else if(file) {
          selectedFiles = selectedFiles.filter(f => f !== file);
          container.remove();
        }
      });
      container.appendChild(btn);
    }
    return container;
  }

  modalImages.addEventListener('change', (e)=>{
    const files = Array.from(e.target.files || []);
    selectedFiles = selectedFiles.concat(files);
    const remoteCount = Array.from(imagesPreview.children).filter(n => n.dataset && n.dataset.remote === 'true').length;
    const total = remoteCount + selectedFiles.length;
    if(total > 5){
      showToast('M√°ximo 5 im√°genes permitidas', false);
      selectedFiles = selectedFiles.slice(0, 5 - remoteCount);
    }
    const remoteNodes = Array.from(imagesPreview.children).filter(n => n.dataset && n.dataset.remote === 'true');
    imagesPreview.innerHTML = '';
    remoteNodes.forEach(n=> imagesPreview.appendChild(n));
    selectedFiles.forEach(f=>{
      const wrap = createImagePreviewElement(f, null, true);
      imagesPreview.appendChild(wrap);
    });
  });

  modalImage.addEventListener('change', (e)=>{
    const f = e.target.files[0];
    if(f){ if(lastObjectUrl) URL.revokeObjectURL(lastObjectUrl); lastObjectUrl = URL.createObjectURL(f); modalPreview.src = lastObjectUrl; }
  });

  modalApk.addEventListener('change', (e)=>{
    const f = e.target.files[0];
    apkName.textContent = f ? f.name : '';
  });

  // ---------- Submit form (create/update) ----------
  modalForm.addEventListener('submit', async (e)=>{
    e.preventDefault();
    const name = modalName.value.trim();
    if(!name){ alert('El nombre es obligatorio'); return; }

    const remoteImgs = Array.from(imagesPreview.children).filter(n => n.dataset && n.dataset.remote === 'true').map(n=>n.dataset.src);
    const totalImagesCount = remoteImgs.length + selectedFiles.length;

    if(!editingId){
      if(totalImagesCount < 3){ showToast('Sube al menos 3 im√°genes de muestra antes de crear', false); return; }
    } else {
      if(selectedFiles.length > 0 && (selectedFiles.length < 3 || selectedFiles.length > 5)){ showToast('Al actualizar con nuevas im√°genes, sube entre 3 y 5 im√°genes', false); return; }
    }

    modalSave.disabled = true; modalSave.textContent = '‚è≥ Guardando...';

    try {
      const fd = new FormData();
      fd.append('name', name);
      fd.append('description', modalDesc.value.trim());
      fd.append('category', modalCategory.value || '');
      fd.append('is_paid', modalIsPaid.checked ? 'true' : 'false');
      if (modalIsPaid.checked && modalPrice.value) fd.append('price', modalPrice.value);
      if(modalVersion.value) fd.append('version', modalVersion.value.trim());
      if(modalImage.files[0]) fd.append('image', modalImage.files[0]);
      if(modalApk.files[0]) fd.append('apk', modalApk.files[0]);

      fd.append('existing_images', JSON.stringify(remoteImgs));
      if(selectedFiles.length){
        selectedFiles.forEach(f => fd.append('images', f));
      }

      let res;
      if(editingId){
        res = await fetch(`/api/apps/${editingId}`, { method:'PUT', body: fd, credentials:'include' });
      } else {
        res = await fetch('/api/apps', { method:'POST', body: fd, credentials:'include' });
      }

      const ctype = res.headers.get('content-type') || '';
      const data = ctype.includes('application/json') ? await res.json() : await res.text();
      if(!res.ok) throw new Error(data.message || JSON.stringify(data));

      showToast(editingId ? 'Actualizaci√≥n guardada' : 'App creada');
      closeModal(modalBackdrop);
      await loadCategories(); await fetchApps();
    } catch (err) {
      console.error(err);
      showToast(err.message || 'Error', false);
    } finally {
      modalSave.disabled = false; modalSave.textContent = 'Guardar cambios';
      selectedFiles = [];
    }
  });

  // ---------- Modal Detalle ----------
  const detailModal = document.getElementById('detailBackdrop');
  const detailContent = document.getElementById('detailContent');
  const detailClose = document.getElementById('detailClose');
  function openDetail(id){
    const app = apps.find(a=>a.id===id);
    if(!app) return showToast('App no encontrada', false);
    detailContent.innerHTML = `
      <h4 style="margin-top:6px">${app.name}</h4>
      <p style="color:var(--muted)">${app.description || ''}</p>
      <p><strong>Versi√≥n:</strong> ${app.version || '‚Äî'}</p>
      <p><strong>Categor√≠a:</strong> ${app.category || '‚Äî'}</p>
      <p><strong>Precio:</strong> ${app.is_paid ? `$${formatPrice(app.price)}` : 'Gratis'}</p>
      <div class="gallery"></div>
    `;
    const gal = detailContent.querySelector('.gallery');
    const imgs = app.images && Array.isArray(app.images) ? app.images : (app.images ? JSON.parse(app.images) : []);
    if(imgs.length){
      imgs.forEach(u=>{ const im = document.createElement('img'); im.src = u; gal.appendChild(im); });
    } else {
      gal.innerHTML = '<p style="color:var(--muted)">No hay im√°genes de muestra.</p>';
    }
    detailModal.style.display = 'flex'; detailModal.setAttribute('aria-hidden','false');
  }
  detailClose.addEventListener('click', ()=> { detailModal.style.display='none'; detailModal.setAttribute('aria-hidden','true'); });

  // ---------- filtros & b√∫squeda ----------
  document.getElementById('searchInput').addEventListener('input', ()=> renderApps());
  document.getElementById('categorySelect').addEventListener('change', ()=> renderApps());
  document.getElementById('sortSelect').addEventListener('change', ()=> renderApps());
  document.getElementById('clearFilter').addEventListener('click', ()=> {
    document.getElementById('searchInput').value=''; document.getElementById('categorySelect').value=''; document.getElementById('sortSelect').value='new'; renderApps();
  });

  // ---------- botones header ----------
  document.getElementById('refreshBtn').addEventListener('click', fetchApps);
  document.getElementById('newBtn').addEventListener('click', openCreate);

  // === Mostrar/ocultar campo de precio ===
  modalIsPaid.addEventListener('change', () => {
    priceField.style.display = modalIsPaid.checked ? 'block' : 'none';
  });

  // ---------- Inicializar ----------
  (async function init(){
    await loadCategories();
    await fetchApps();
  })();
</script>

</body>
</html>
